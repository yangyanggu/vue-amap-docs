import{G as he,c as de,E as xt,a as Ct}from"./index-CrMMG-jN.js";import{c as Lt,d as Pe,B as Ze,p as q,_ as L,aC as $,r as Mt,ag as T,G as Et,aD as At,aj as Xe,J as ie,aE as Ke,af as et,aF as Pt,N as G,ah as vt,V as Le,aG as kt,aH as Rt,ao as It}from"./three.module-BVXrWKE2.js";import{p as tt,_ as st,o as Me,c as nt,f as Q,a as Y,d as pe,w as ve,q as Ot,s as Ft,ao as ke,al as Dt}from"./app-BIv4BGsj.js";import{b as Ut,u as Bt,E as Nt}from"./index-XVBT3eyP.js";import"./arrayEach-Bzrg1Ilf.js";const fe=new WeakMap;class Vt extends Lt{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,s,n){const r=new Pe(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,o=>{const a={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(o,a).then(t).catch(n)},s,n)}decodeDracoFile(e,t,s,n){const r={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!s};this.decodeGeometry(e,r).then(t)}decodeGeometry(e,t){for(const c in t.attributeTypes){const h=t.attributeTypes[c];h.BYTES_PER_ELEMENT!==void 0&&(t.attributeTypes[c]=h.name)}const s=JSON.stringify(t);if(fe.has(e)){const c=fe.get(e);if(c.key===s)return c.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const r=this.workerNextTaskID++,o=e.byteLength,a=this._getWorker(r,o).then(c=>(n=c,new Promise((h,l)=>{n._callbacks[r]={resolve:h,reject:l},n.postMessage({type:"decode",id:r,taskConfig:t,buffer:e},[e])}))).then(c=>this._createGeometry(c.geometry));return a.catch(()=>!0).then(()=>{n&&r&&this._releaseTask(n,r)}),fe.set(e,{key:s,promise:a}),a}_createGeometry(e){const t=new Ze;e.index&&t.setIndex(new q(e.index.array,1));for(let s=0;s<e.attributes.length;s++){const n=e.attributes[s],r=n.name,o=n.array,a=n.itemSize;t.setAttribute(r,new q(o,a))}return t}_loadLibrary(e,t){const s=new Pe(this.manager);return s.setPath(this.decoderPath),s.setResponseType(t),s.setWithCredentials(this.withCredentials),new Promise((n,r)=>{s.load(e,n,void 0,r)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(s=>{const n=s[0];e||(this.decoderConfig.wasmBinary=s[1]);const r=zt.toString(),o=["/* draco decoder */",n,"","/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const n=new Worker(this.workerSourceURL);n._callbacks={},n._taskCosts={},n._taskLoad=0,n.postMessage({type:"init",decoderConfig:this.decoderConfig}),n.onmessage=function(r){const o=r.data;switch(o.type){case"decode":n._callbacks[o.id].resolve(o);break;case"error":n._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(n)}else this.workerPool.sort(function(n,r){return n._taskLoad>r._taskLoad?-1:1});const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[e]=t,s._taskLoad+=t,s})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function zt(){let i,e;onmessage=function(o){const a=o.data;switch(a.type){case"init":i=a.decoderConfig,e=new Promise(function(l){i.onModuleLoaded=function(u){l({draco:u})},DracoDecoderModule(i)});break;case"decode":const c=a.buffer,h=a.taskConfig;e.then(l=>{const u=l.draco,d=new u.Decoder,f=new u.DecoderBuffer;f.Init(new Int8Array(c),c.byteLength);try{const p=t(u,d,f,h),m=p.attributes.map(g=>g.array.buffer);p.index&&m.push(p.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:p},m)}catch(p){console.error(p),self.postMessage({type:"error",id:a.id,error:p.message})}finally{u.destroy(f),u.destroy(d)}});break}};function t(o,a,c,h){const l=h.attributeIDs,u=h.attributeTypes;let d,f;const p=a.GetEncodedGeometryType(c);if(p===o.TRIANGULAR_MESH)d=new o.Mesh,f=a.DecodeBufferToMesh(c,d);else if(p===o.POINT_CLOUD)d=new o.PointCloud,f=a.DecodeBufferToPointCloud(c,d);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!f.ok()||d.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+f.error_msg());const m={index:null,attributes:[]};for(const g in l){const _=self[u[g]];let b,S;if(h.useUniqueIDs)S=l[g],b=a.GetAttributeByUniqueId(d,S);else{if(S=a.GetAttributeId(d,o[l[g]]),S===-1)continue;b=a.GetAttribute(d,S)}m.attributes.push(n(o,a,d,g,_,b))}return p===o.TRIANGULAR_MESH&&(m.index=s(o,a,d)),o.destroy(d),m}function s(o,a,c){const l=c.num_faces()*3,u=l*4,d=o._malloc(u);a.GetTrianglesUInt32Array(c,u,d);const f=new Uint32Array(o.HEAPF32.buffer,d,l).slice();return o._free(d),{array:f,itemSize:1}}function n(o,a,c,h,l,u){const d=u.num_components(),p=c.num_points()*d,m=p*l.BYTES_PER_ELEMENT,g=r(o,l),_=o._malloc(m);a.GetAttributeDataArrayForAllPoints(c,u,g,m,_);const b=new l(o.HEAPF32.buffer,_,p).slice();return o._free(_),{name:h,array:b,itemSize:d}}function r(o,a){switch(a){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}function Re(i){let e;try{e=new URL(i,"http://fakehost.com/")}catch{return null}const t=e.pathname.split("/").pop(),s=t.lastIndexOf(".");return s===-1||s===t.length-1?null:t.substring(s+1)}function Gt(i){Promise.resolve().then(i)}class jt{constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const s=this.itemSet;if(s.has(e)||this.isFull())return!1;const n=this.usedSet,r=this.itemList,o=this.callbacks;return r.push(e),n.add(e),s.set(e,Date.now()),o.set(e,t),!0}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,r=this.callbacks;if(s.has(e)){r.get(e)(e);const o=n.indexOf(e);return n.splice(o,1),t.delete(e),s.delete(e),r.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,s=this.itemList,n=this.itemSet,r=this.usedSet,o=this.callbacks,a=s.length-r.size,c=s.length-t,h=this.unloadPriorityCallback||this.defaultPriorityCallback;if(c>0&&a>0){s.sort((p,m)=>{const g=r.has(p),_=r.has(m);return g&&_?0:!g&&!_?h(m)-h(p):g?1:-1});const l=Math.min(c,a),u=Math.max(t*e,l*e);let d=Math.min(u,a);d=Math.ceil(d);const f=s.splice(0,d);for(let p=0,m=f.length;p<m;p++){const g=f[p];o.get(g)(g),n.delete(g),o.delete(g)}}}scheduleUnload(e=!0){this.scheduled||(this.scheduled=!0,Gt(()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()}))}}class Ie{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise((s,n)=>{const r=(...c)=>t(...c).then(s).catch(n),o=this.items,a=this.callbacks;o.push(e),a.set(e,r),this.autoUpdate&&this.scheduleJobRun()})}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);n!==-1&&(t.splice(n,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=this.currJobs;for(;s>n&&e.length>0;){n++;const r=e.pop(),o=t.get(r);t.delete(r),o(r).then(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}).catch(()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const Z=0,X=1,me=2,W=3,ae=4,ce=6378137,Ht=1/298.257223563,qt=-(Ht*ce-ce);function Ee(i){return i===W||i===ae}function D(i,e){return i.__lastFrameVisited===e&&i.__used}function rt(i,e){i.__lastFrameVisited!==e&&(i.__lastFrameVisited=e,i.__used=!1,i.__inFrustum=!1,i.__isLeaf=!1,i.__visible=!1,i.__active=!1,i.__error=1/0,i.__distanceFromCamera=1/0,i.__childrenWereVisible=!1,i.__allChildrenLoaded=!1)}function ot(i,e,t,s){if(s.ensureChildrenArePreprocessed(i),rt(i,e),i.__used=!0,t.markUsed(i),i.__contentEmpty){const n=i.children;for(let r=0,o=n.length;r<o;r++)ot(n[r],e,t,s)}}function it(i,e,t){if(t.ensureChildrenArePreprocessed(i),i.__contentEmpty&&(!i.__externalTileSet||Ee(i.__loadingState))){const n=i.children;for(let r=0,o=n.length;r<o;r++){const a=n[r];a.__depthFromRenderedParent=e,it(a,e,t)}}else t.requestTileContents(i)}function at(i,e=null,t=null,s=null,n=0){if(e&&e(i,s,n)){t&&t(i,s,n);return}const r=i.children;for(let o=0,a=r.length;o<a;o++)at(r[o],e,t,i,n+1);t&&t(i,s,n)}function ct(i,e){e.ensureChildrenArePreprocessed(i);const t=e.stats,s=e.frameCount,n=e.errorTarget,r=e.maxDepth,o=e.loadSiblings,a=e.lruCache,c=e.stopAtEmptyTiles;if(rt(i,s),e.tileInView(i)===!1)return!1;if(i.__used=!0,a.markUsed(i),i.__inFrustum=!0,t.inFrustum++,(c||!i.__contentEmpty)&&!i.__externalTileSet&&(e.calculateError(i),i.__error<=n||e.maxDepth>0&&i.__depth+1>=r))return!0;let l=!1;const u=i.children;for(let d=0,f=u.length;d<f;d++){const p=u[d],m=ct(p,e);l=l||m}if(l&&o)for(let d=0,f=u.length;d<f;d++){const p=u[d];ot(p,s,a,e)}return!0}function lt(i,e){const t=e.stats,s=e.frameCount;if(!D(i,s))return;t.used++;const n=i.children;let r=!1;for(let o=0,a=n.length;o<a;o++){const c=n[o];r=r||D(c,s)}if(!r)i.__isLeaf=!0;else{let o=!1,a=!0;for(let c=0,h=n.length;c<h;c++){const l=n[c];if(lt(l,e),o=o||l.__wasSetVisible||l.__childrenWereVisible,D(l,s)){const u=l.__allChildrenLoaded||!l.__contentEmpty&&Ee(l.__loadingState)||l.__externalTileSet&&l.__loadingState===ae;a=a&&u}}i.__childrenWereVisible=o,i.__allChildrenLoaded=a}}function ht(i,e){const t=e.stats,s=e.frameCount;if(!D(i,s))return;const n=i.parent,r=n?n.__depthFromRenderedParent:-1;i.__depthFromRenderedParent=r;const o=e.lruCache;if(i.__isLeaf){i.__depthFromRenderedParent++,i.__loadingState===W?(i.__inFrustum&&(i.__visible=!0,t.visible++),i.__active=!0,t.active++):!o.isFull()&&(!i.__contentEmpty||i.__externalTileSet)&&e.requestTileContents(i);return}const a=(e.errorTarget+1)*e.errorThreshold,c=i.__error<=a,h=c||i.refine==="ADD",l=!i.__contentEmpty,u=l||i.__externalTileSet,d=Ee(i.__loadingState)&&u,f=i.__childrenWereVisible,p=i.children,m=i.__allChildrenLoaded;if(h&&l&&i.__depthFromRenderedParent++,h&&!d&&!o.isFull()&&u&&e.requestTileContents(i),(c&&!m&&!f&&d||i.refine==="ADD"&&d)&&(i.__inFrustum&&(i.__visible=!0,t.visible++),i.__active=!0,t.active++),i.refine!=="ADD"&&c&&!m&&d)for(let g=0,_=p.length;g<_;g++){const b=p[g];D(b,s)&&!o.isFull()&&(b.__depthFromRenderedParent=i.__depthFromRenderedParent+1,it(b,b.__depthFromRenderedParent,e))}else for(let g=0,_=p.length;g<_;g++){const b=p[g];D(b,s)&&ht(b,e)}}function ut(i,e){const t=e.frameCount,s=D(i,t);if(s||i.__usedLastFrame){let n=!1,r=!1;s&&(n=i.__active,e.displayActiveTiles?r=i.__active||i.__visible:r=i.__visible),!i.__contentEmpty&&i.__loadingState===W&&(i.__wasSetActive!==n&&e.setTileActive(i,n),i.__wasSetVisible!==r&&e.setTileVisible(i,r)),i.__wasSetActive=n,i.__wasSetVisible=r,i.__usedLastFrame=s;const o=i.children;for(let a=0,c=o.length;a<c;a++){const h=o[a];ut(h,e)}}}const Oe=(i,e)=>i.__depth!==e.__depth?i.__depth>e.__depth?-1:1:i.__inFrustum!==e.__inFrustum?i.__inFrustum?1:-1:i.__used!==e.__used?i.__used?1:-1:i.__error!==e.__error?i.__error>e.__error?1:-1:i.__distanceFromCamera!==e.__distanceFromCamera?i.__distanceFromCamera>e.__distanceFromCamera?-1:1:0,Wt=i=>1/(i.__depthFromRenderedParent+1);class $t{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}constructor(e){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.preprocessURL=null;const t=new jt;t.unloadPriorityCallback=Wt;const s=new Ie;s.maxJobs=4,s.priorityCallback=Oe;const n=new Ie;n.maxJobs=1,n.priorityCallback=Oe,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0}traverse(e,t){const n=this.tileSets[this.rootURL];!n||!n.root||at(n.root,(r,...o)=>(this.ensureChildrenArePreprocessed(r),e?e(r,...o):!1),t)}update(){const e=this.stats,t=this.lruCache,s=this.tileSets,n=s[this.rootURL];if(this.rootURL in s){if(!n||!n.root)return}else{this.loadRootTileSet(this.rootURL);return}const r=n.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,ct(r,this),lt(r,this),ht(r,this),ut(r,this),t.scheduleUnload()}parseTile(e,t,s){return null}disposeTile(e){}preprocessNode(e,t,s=null){if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=new URL(e.content.uri,t+"/").toString()),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],e.content&&e.content.uri){const r=Re(e.content.uri),o=!!(r&&r.toLowerCase()==="json");e.__externalTileSet=o,e.__contentEmpty=o}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=Z,e.__loadIndex=0,e.__loadAbort=null,e.__depthFromRenderedParent=-1,s===null?(e.__depth=0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.refine=e.refine||s.refine),e.__basePath=t}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}ensureChildrenArePreprocessed(e){const t=e.children;for(let s=0,n=t.length;s<n;s++){const r=t[s];if("__depth"in r)break;this.preprocessNode(r,e.__basePath,e)}}resetFailedTiles(){const e=this.stats;e.failed!==0&&(this.traverse(t=>{t.__loadingState===ae&&(t.__loadingState=Z)}),e.failed=0)}fetchTileSet(e,t,s=null){return fetch(e,t).then(n=>{if(n.ok)return n.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${n.status} : ${n.statusText}`)}).then(n=>{const r=n.asset.version;console.assert(r==="1.0"||r==="0.0",'asset.version is expected to be a string of "1.0" or "0.0"');let o=e.replace(/\/[^\/]*\/?$/,"");return o=new URL(o,window.location.href).toString(),this.preprocessNode(n.root,o,s),n})}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{const s=this.fetchTileSet(this.preprocessURL?this.preprocessURL(e):e,this.fetchOptions).then(n=>{t[e]=n});return s.catch(n=>{console.error(n),t[e]=n}),t[e]=s,s}}requestTileContents(e){if(e.__loadingState!==Z)return;const t=this.stats,s=this.lruCache,n=this.downloadQueue,r=this.parseQueue,o=e.__externalTileSet;s.add(e,u=>{u.__loadingState===X?(u.__loadAbort.abort(),u.__loadAbort=null):o?u.children.length=0:this.disposeTile(u),u.__loadingState===X?t.downloading--:u.__loadingState===me&&t.parsing--,u.__loadingState=Z,u.__loadIndex++,r.remove(u),n.remove(u)}),e.__loadIndex++;const a=e.__loadIndex,c=new AbortController,h=c.signal;t.downloading++,e.__loadAbort=c,e.__loadingState=X;const l=u=>{e.__loadIndex===a&&(u.name!=="AbortError"?(r.remove(e),n.remove(e),e.__loadingState===me?t.parsing--:e.__loadingState===X&&t.downloading--,t.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(u),e.__loadingState=ae):s.remove(e))};o?n.add(e,u=>{if(u.__loadIndex!==a)return Promise.resolve();const d=this.preprocessURL?this.preprocessURL(u.content.uri):u.content.uri;return this.fetchTileSet(d,Object.assign({signal:h},this.fetchOptions),u)}).then(u=>{e.__loadIndex===a&&(t.downloading--,e.__loadAbort=null,e.__loadingState=W,e.children.push(u.root))}).catch(l):n.add(e,u=>{if(u.__loadIndex!==a)return Promise.resolve();const d=this.preprocessURL?this.preprocessURL(u.content.uri):u.content.uri;return fetch(d,Object.assign({signal:h},this.fetchOptions))}).then(u=>{if(e.__loadIndex===a){if(u.ok)return u.arrayBuffer();throw new Error(`Failed to load model with error code ${u.status}`)}}).then(u=>{if(e.__loadIndex===a)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=me,r.add(e,d=>{if(d.__loadIndex!==a)return Promise.resolve();const f=d.content.uri,p=Re(f);return this.parseTile(u,d,p)})}).then(()=>{e.__loadIndex===a&&(t.parsing--,e.__loadingState=W,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))}).catch(l)}dispose(){const e=this.lruCache,t=[];this.traverse(s=>(t.push(s),!1));for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}}function dt(i){return new TextDecoder().decode(i)}class ue{constructor(e,t,s,n){this.buffer=e,this.binOffset=t+s,this.binLength=n;let r=null;if(s!==0){const o=new Uint8Array(e,t,s);r=JSON.parse(dt(o))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,n=null){const r=this.header;if(!(e in r))return null;const o=r[e];if(o instanceof Object){if(Array.isArray(o))return o;{const{buffer:a,binOffset:c,binLength:h}=this,l=o.byteOffset||0,u=o.type||n,d=o.componentType||s;if("type"in o&&n&&o.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");let f;switch(u){case"SCALAR":f=1;break;case"VEC2":f=2;break;case"VEC3":f=3;break;case"VEC4":f=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${e}".`)}let p;const m=c+l,g=t*f;switch(d){case"BYTE":p=new Int8Array(a,m,g);break;case"UNSIGNED_BYTE":p=new Uint8Array(a,m,g);break;case"SHORT":p=new Int16Array(a,m,g);break;case"UNSIGNED_SHORT":p=new Uint16Array(a,m,g);break;case"INT":p=new Int32Array(a,m,g);break;case"UNSIGNED_INT":p=new Uint32Array(a,m,g);break;case"FLOAT":p=new Float32Array(a,m,g);break;case"DOUBLE":p=new Float64Array(a,m,g);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${e}".`)}if(m+g*p.BYTES_PER_ELEMENT>c+h)throw new Error("FeatureTable: Feature data read outside binary body length.");return p}}else return o}getBuffer(e,t){const{buffer:s,binOffset:n}=this;return s.slice(n+e,n+e+t)}}class Ae extends ue{constructor(e,t,s,n,r){super(e,s,n,r),this.batchSize=t}getData(e,t=null,s=null){return super.getData(e,this.batchSize,t,s)}}class J{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return fetch(e,this.fetchOptions).then(t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()}).then(t=>(this.workingPath===""&&(this.workingPath=this.workingPathForURL(e)),this.parse(t)))}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);return t.pop(),t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}function z(i){let e;if(i instanceof DataView?e=i:e=new DataView(i),String.fromCharCode(e.getUint8(0))==="{")return null;let t="";for(let s=0;s<4;s++)t+=String.fromCharCode(e.getUint8(s));return t}class Jt extends J{parse(e){const t=new DataView(e),s=z(t);console.assert(s==="b3dm");const n=t.getUint32(4,!0);console.assert(n===1);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const o=t.getUint32(12,!0),a=t.getUint32(16,!0),c=t.getUint32(20,!0),h=t.getUint32(24,!0),l=28,u=e.slice(l,l+o+a),d=new ue(u,0,o,a),f=l+o+a,p=e.slice(f,f+c+h),m=new Ae(p,d.getData("BATCH_LENGTH"),0,c,h),g=f+c+h,_=new Uint8Array(e,g,r-g);return{version:n,featureTable:d,batchTable:m,glbBytes:_}}}class pt extends Jt{constructor(e=$){super(),this.manager=e,this.adjustmentTransform=new L}parse(e){const t=super.parse(e),s=t.glbBytes.slice().buffer;return new Promise((n,r)=>{const o=this.manager,a=this.fetchOptions,c=o.getHandler("path.gltf")||new he(o);a.credentials==="include"&&a.mode==="cors"&&c.setCrossOrigin("use-credentials"),"credentials"in a&&c.setWithCredentials(a.credentials==="include"),a.headers&&c.setRequestHeader(a.headers);let h=this.workingPath;!/[\\/]$/.test(h)&&h.length&&(h+="/");const l=this.adjustmentTransform;c.parse(s,h,u=>{const{batchTable:d,featureTable:f}=t,{scene:p}=u,m=f.getData("RTC_CENTER");m&&(p.position.x+=m[0],p.position.y+=m[1],p.position.z+=m[2]),u.scene.updateMatrix(),u.scene.matrix.multiply(l),u.scene.matrix.decompose(u.scene.position,u.scene.quaternion,u.scene.scale),u.batchTable=d,u.featureTable=f,p.batchTable=d,p.featureTable=f,n(u)},r)})}}class Qt extends J{parse(e){const t=new DataView(e),s=z(t);console.assert(s==="pnts");const n=t.getUint32(4,!0);console.assert(n===1);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const o=t.getUint32(12,!0),a=t.getUint32(16,!0),c=t.getUint32(20,!0),h=t.getUint32(24,!0),l=28,u=e.slice(l,l+o+a),d=new ue(u,0,o,a),f=l+o+a,p=e.slice(f,f+c+h),m=new Ae(p,d.getData("BATCH_LENGTH")||d.getData("POINTS_LENGTH"),0,c,h);return Promise.resolve({version:n,featureTable:d,batchTable:m})}}const Fe={RGB:"color",POSITION:"position"};class ft extends Qt{constructor(e=$){super(),this.manager=e}parse(e){return super.parse(e).then(async t=>{const{featureTable:s}=t,n=new Mt,r=s.header.extensions,o=new T;let a;if(r&&r["3DTILES_draco_point_compression"]){const{byteOffset:l,byteLength:u,properties:d}=r["3DTILES_draco_point_compression"],f=this.manager.getHandler("draco.drc");if(f==null)throw new Error("PNTSLoader: dracoLoader not available.");const p={};for(const _ in d)if(_ in Fe&&_ in d){const b=Fe[_];p[b]=d[_]}const m={attributeIDs:p,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},g=s.getBuffer(l,u);a=await f.decodeGeometry(g,m),a.attributes.color&&(n.vertexColors=!0)}else{const l=s.getData("POINTS_LENGTH"),u=s.getData("POSITION",l,"FLOAT","VEC3"),d=s.getData("RGB",l,"UNSIGNED_BYTE","VEC3"),f=s.getData("POSITION_QUANTIZED",l,"UNSIGNED_SHORT","VEC3"),p=s.getData("QUANTIZED_VOLUME_SCALE",l,"FLOAT","VEC3"),m=s.getData("QUANTIZED_VOLUME_OFFSET",l,"FLOAT","VEC3");if(a=new Ze,f){const g=new Float32Array(l*3);for(let _=0;_<l;_++)for(let b=0;b<3;b++){const S=3*_+b;g[S]=f[S]/65535*p[b]}o.x=m[0],o.y=m[1],o.z=m[2],a.setAttribute("position",new q(g,3,!1))}else a.setAttribute("position",new q(u,3,!1));d!==null&&(a.setAttribute("color",new q(d,3,!0)),n.vertexColors=!0)}["CONSTANT_RGBA","BATCH_LENGTH","RGBA","RGB565","NORMAL","NORMAL_OCT16P"].forEach(l=>{l in s.header&&console.warn(`PNTSLoader: Unsupported FeatureTable feature "${l}" detected.`)});const c=new Et(a,n);c.position.copy(o),t.scene=c,t.scene.featureTable=s;const h=s.getData("RTC_CENTER");return h&&(t.scene.position.x+=h[0],t.scene.position.y+=h[1],t.scene.position.z+=h[2]),t})}}class Yt extends J{parse(e){const t=new DataView(e),s=z(t);console.assert(s==="i3dm");const n=t.getUint32(4,!0);console.assert(n===1);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const o=t.getUint32(12,!0),a=t.getUint32(16,!0),c=t.getUint32(20,!0),h=t.getUint32(24,!0),l=t.getUint32(28,!0),u=32,d=e.slice(u,u+o+a),f=new ue(d,0,o,a),p=u+o+a,m=e.slice(p,p+c+h),g=new Ae(m,f.getData("INSTANCES_LENGTH"),0,c,h),_=p+c+h,b=new Uint8Array(e,_,r-_);let S=null,x=null;if(l)S=b,x=Promise.resolve();else{const E=this.resolveExternalURL(dt(b));x=fetch(E,this.fetchOptions).then(w=>{if(!w.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${E}" with status ${w.status} : ${w.statusText}`);return w.arrayBuffer()}).then(w=>{S=new Uint8Array(w)})}return x.then(()=>({version:n,featureTable:f,batchTable:g,glbBytes:S}))}}const De=new T,ge=new T,_e=new T,Ue=new T,be=new Xe,K=new T,ee=new L;class mt extends Yt{constructor(e=$){super(),this.manager=e,this.adjustmentTransform=new L}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then(t=>{const{featureTable:s,batchTable:n}=t,r=t.glbBytes.slice().buffer;return new Promise((o,a)=>{const c=this.fetchOptions,h=this.manager,l=h.getHandler("path.gltf")||new he(h);c.credentials==="include"&&c.mode==="cors"&&l.setCrossOrigin("use-credentials"),"credentials"in c&&l.setWithCredentials(c.credentials==="include"),c.headers&&l.setRequestHeader(c.headers);let u=this.workingPath;/[\\/]$/.test(u)||(u+="/");const d=this.adjustmentTransform;l.parse(r,u,f=>{const p=s.getData("INSTANCES_LENGTH"),m=s.getData("POSITION",p,"FLOAT","VEC3"),g=s.getData("NORMAL_UP",p,"FLOAT","VEC3"),_=s.getData("NORMAL_RIGHT",p,"FLOAT","VEC3"),b=s.getData("SCALE_NON_UNIFORM",p,"FLOAT","VEC3"),S=s.getData("SCALE",p,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach(y=>{y in s.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${y}" detected.`)});const x=new Map,E=[];f.scene.traverse(y=>{if(y.isMesh){const{geometry:A,material:M}=y,v=new At(A,M,p);v.position.copy(y.position),v.rotation.copy(y.rotation),v.scale.copy(y.scale),E.push(v),x.set(y,v)}});const w=new T;for(let y=0;y<p;y++)w.x+=m[y*3+0]/p,w.y+=m[y*3+1]/p,w.z+=m[y*3+2]/p;x.forEach((y,A)=>{const M=A.parent;M&&(M.remove(A),M.add(y),y.updateMatrixWorld(),y.position.copy(w).applyMatrix4(y.matrixWorld))});for(let y=0;y<p;y++){Ue.set(m[y*3+0]-w.x,m[y*3+1]-w.y,m[y*3+2]-w.z),g?(ge.set(g[y*3+0],g[y*3+1],g[y*3+2]),_e.set(_[y*3+0],_[y*3+1],_[y*3+2]),De.crossVectors(_e,ge).normalize(),ee.makeBasis(_e,ge,De),be.setFromRotationMatrix(ee)):be.set(0,0,0,1),S?K.setScalar(S[y]):b?K.set(b[y*3+0],b[y*3+1],b[y*3+2]):K.set(1,1,1),ee.compose(Ue,be,K).multiply(d);for(let A=0,M=E.length;A<M;A++)E[A].setMatrixAt(y,ee)}f.batchTable=n,f.featureTable=s,f.scene.batchTable=n,f.scene.featureTable=s,o(f)},a)})})}}class Zt extends J{parse(e){const t=new DataView(e),s=z(t);console.assert(s==="cmpt",'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(n===1,'CMPTLoader: The version listed in the header is "1".');const r=t.getUint32(8,!0);console.assert(r===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const o=t.getUint32(12,!0),a=[];let c=16;for(let h=0;h<o;h++){const l=new DataView(e,c,12),u=z(l),d=l.getUint32(4,!0),f=l.getUint32(8,!0),p=new Uint8Array(e,c,f);a.push({type:u,buffer:p,version:d}),c+=f}return{version:n,tiles:a}}}class Xt extends Zt{constructor(e=$){super(),this.manager=e,this.adjustmentTransform=new L}parse(e){const t=super.parse(e),s=this.manager,n=this.adjustmentTransform,r=[];for(const o in t.tiles){const{type:a,buffer:c}=t.tiles[o];switch(a){case"b3dm":{const h=c.slice(),l=new pt(s);l.workingPath=this.workingPath,l.fetchOptions=this.fetchOptions,l.adjustmentTransform.copy(n);const u=l.parse(h.buffer);r.push(u);break}case"pnts":{const h=c.slice(),l=new ft(s);l.workingPath=this.workingPath,l.fetchOptions=this.fetchOptions;const u=l.parse(h.buffer);r.push(u);break}case"i3dm":{const h=c.slice(),l=new mt(s);l.workingPath=this.workingPath,l.fetchOptions=this.fetchOptions,l.adjustmentTransform.copy(n);const u=l.parse(h.buffer);r.push(u);break}}}return Promise.all(r).then(o=>{const a=new ie;return o.forEach(c=>{a.add(c.scene)}),{tiles:o,scene:a}})}}class Kt{constructor(){this.name="CESIUM_RTC"}afterRoot(e){if(e.parser.json.extensions&&e.parser.json.extensions.CESIUM_RTC){const{center:t}=e.parser.json.extensions.CESIUM_RTC;t&&(e.scene.position.x+=t[0],e.scene.position.y+=t[1],e.scene.position.z+=t[2])}}}class es extends J{constructor(e=$){super(),this.manager=e}parse(e){return new Promise((t,s)=>{const n=this.manager,r=this.fetchOptions;let o=n.getHandler("path.gltf")||n.getHandler("path.glb");o||(o=new he(n),o.register(()=>new Kt),r.credentials==="include"&&r.mode==="cors"&&o.setCrossOrigin("use-credentials"),"credentials"in r&&o.setWithCredentials(r.credentials==="include"),r.headers&&o.setRequestHeader(r.headers));let a=o.resourcePath||o.path||this.workingPath;!/[\\/]$/.test(a)&&a.length&&(a+="/"),o.parse(e,a,c=>{t(c)},s)})}}const te=new L;class ts extends ie{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){this.tilesRenderer.optimizeRaycast&&this.tilesRenderer.raycast(e,t)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){this.parent===null?te.copy(this.matrix):te.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=te.elements,s=this.matrixWorld.elements;let n=!1;for(let r=0;r<16;r++){const o=t[r],a=s[r];if(Math.abs(o-a)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(te);const r=this.children;for(let o=0,a=r.length;o<a;o++)r[o].updateMatrixWorld()}}}}const le=new L,gt=new Ke,ye=new T,se=[];function _t(i,e){return i.distance-e.distance}function bt(i,e,t){i.traverse(s=>{Object.getPrototypeOf(s).raycast.call(s,e,t)})}function ss(i,e){bt(i,e,se),se.sort(_t);const t=se[0]||null;return se.length=0,t}function yt(i,e,t,s=null){const{group:n,activeTiles:r}=i;i.ensureChildrenArePreprocessed(e),s===null&&(s=gt,le.copy(n.matrixWorld).invert(),s.copy(t.ray).applyMatrix4(le));const o=[],a=e.children;for(let l=0,u=a.length;l<u;l++){const d=a[l];if(!d.__used)continue;d.cached.boundingVolume.intersectRay(s,ye)!==null&&(ye.applyMatrix4(n.matrixWorld),o.push({distance:ye.distanceToSquared(t.ray.origin),tile:d}))}o.sort(_t);let c=null,h=1/0;if(r.has(e)){const l=ss(e.cached.scene,t);l&&(c=l,h=l.distance*l.distance)}for(let l=0,u=o.length;l<u;l++){const d=o[l],f=d.distance,p=d.tile;if(f>h)break;const m=yt(i,p,t,s);if(m){const g=m.distance*m.distance;g<h&&(c=m,h=g)}}return c}function Tt(i,e,t,s,n=null){const{group:r,activeTiles:o}=i,{scene:a,boundingVolume:c}=e.cached;if(i.ensureChildrenArePreprocessed(e),n===null&&(n=gt,le.copy(r.matrixWorld).invert(),n.copy(t.ray).applyMatrix4(le)),!e.__used||!c.intersectsRay(n))return;o.has(e)&&bt(a,t,s);const h=e.children;for(let l=0,u=h.length;l<u;l++)Tt(i,h[l],t,s,n)}class Be{constructor(e=new et,t=new L){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new L,this.points=new Array(8).fill().map(()=>new T)}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:r,max:o}=n;let a=0;for(let c=-1;c<=1;c+=2)for(let h=-1;h<=1;h+=2)for(let l=-1;l<=1;l+=2)e[a].set(c<0?r.x:o.x,h<0?r.y:o.y,l<0?r.z:o.z).applyMatrix4(s),a++}intersectsFrustum(e){const{points:t}=this,{planes:s}=e;for(let n=0;n<6;n++){const r=s[n];let o=-1/0;for(let a=0;a<8;a++){const c=t[a],h=r.distanceToPoint(c);o=o<h?h:o}if(o<0)return!1}return!0}}new T;function ns(i){const{x:e,y:t,z:s}=i;i.x=s,i.y=e,i.z=t}function rs(i){return-i+Math.PI/2}const Ne=new Pt,O=new T,P=new T,Te=new T,os=new T,Ve=new T,we=new T,Se=new T,ze=new T,is=1e-12,as=.1;class cs{constructor(e=1,t=1,s=1){this.radius=new T(e,t,s)}constructLatLonFrame(e,t,s){return this.getCartographicToPosition(e,t,0,ze),this.getCartographicToNormal(e,t,Se),this.getNorthernTangent(e,t,we),Ve.crossVectors(we,Se),s.makeBasis(Ve,we,Se).setPosition(ze)}getNorthernTangent(e,t,s,n=os){let r=1,o=e+1e-7;e>Math.PI/4&&(r=-1,o=e-1e-7);const a=this.getCartographicToNormal(e,t,P).normalize(),c=this.getCartographicToNormal(o,t,Te).normalize();return n.crossVectors(a,c).normalize().multiplyScalar(r),s.crossVectors(n,a).normalize()}getCartographicToPosition(e,t,s,n){this.getCartographicToNormal(e,t,O);const r=this.radius;P.copy(O),P.x*=r.x**2,P.y*=r.y**2,P.z*=r.z**2;const o=Math.sqrt(O.dot(P));return P.divideScalar(o),n.copy(P).addScaledVector(O,s)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,P),this.getPositionToNormal(e,O);const s=Te.subVectors(e,P);return t.lon=Math.atan2(O.y,O.x),t.lat=Math.asin(O.z),t.height=Math.sign(s.dot(e))*s.length(),t}getCartographicToNormal(e,t,s){return Ne.set(1,rs(e),t),s.setFromSpherical(Ne).normalize(),ns(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=s.x**2,t.y/=s.y**2,t.z/=s.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const s=this.radius,n=1/s.x**2,r=1/s.y**2,o=1/s.z**2,a=e.x*e.x*n,c=e.y*e.y*r,h=e.z*e.z*o,l=a+c+h,u=Math.sqrt(1/l),d=P.copy(e).multiplyScalar(u);if(l<as)return isFinite(u)?t.copy(d):null;const f=Te.set(d.x*n*2,d.y*r*2,d.z*o*2);let p=(1-u)*e.length()/(.5*f.length()),m=0,g,_,b,S,x,E,w,y,A,M,v;do{p-=m,b=1/(1+p*n),S=1/(1+p*r),x=1/(1+p*o),E=b*b,w=S*S,y=x*x,A=E*b,M=w*S,v=y*x,g=a*E+c*w+h*y-1,_=a*A*n+c*M*r+h*v*o;const St=-2*_;m=g/St}while(Math.abs(g)>is);return t.set(e.x*b,e.y*S,e.z*x)}}const F=Math.PI,ne=F/2,j=new T,U=new T,B=new T,Ge=new L;let H=0;const xe=[];function ls(i=!1){return i?(xe[H]||(xe[H]=new T),H++,xe[H-1]):new T}function je(){H=0}class hs extends cs{constructor(e,t,s,n=-ne,r=ne,o=0,a=2*F,c=0,h=0){super(e,t,s),this.latStart=n,this.latEnd=r,this.lonStart=o,this.lonEnd=a,this.heightStart=c,this.heightEnd=h}_getPoints(e=!1){const{latStart:t,latEnd:s,lonStart:n,lonEnd:r,heightStart:o,heightEnd:a}=this,c=G.mapLinear(.5,0,1,t,s),h=G.mapLinear(.5,0,1,n,r),l=Math.floor(n/ne)*ne,u=[[-F/2,0],[F/2,0],[0,l],[0,l+F/2],[0,l+F],[0,l+3*F/2],[t,r],[s,r],[t,n],[s,n],[0,n],[0,r],[c,h],[t,h],[s,h],[c,n],[c,r]],d=[],f=u.length;for(let p=0;p<=1;p++){const m=G.mapLinear(p,0,1,o,a);for(let g=0,_=f;g<_;g++){const[b,S]=u[g];if(b>=t&&b<=s&&S>=n&&S<=r){const x=ls(e);d.push(x),this.getCartographicToPosition(b,S,m,x)}}}return d}getBoundingBox(e,t){je();const{latStart:s,latEnd:n,lonStart:r,lonEnd:o}=this;if(n-s<F/2){const h=G.mapLinear(.5,0,1,s,n),l=G.mapLinear(.5,0,1,r,o);this.getCartographicToNormal(h,l,B),U.set(0,0,1),j.crossVectors(U,B),U.crossVectors(j,B),t.makeBasis(j,U,B)}else j.set(1,0,0),U.set(0,1,0),B.set(0,0,1),t.makeBasis(j,U,B);Ge.copy(t).invert();const c=this._getPoints(!0);for(let h=0,l=c.length;h<l;h++)c[h].applyMatrix4(Ge);e.makeEmpty(),e.setFromPoints(c)}getBoundingSphere(e,t){je();const s=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(s,t)}}const k=new T,R=new T,I=new T,He=new T,qe=new T,We=new T,N=new Ke;class us{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t)||s&&(N.copy(e).applyMatrix4(s.inverseTransform),!N.intersectsBox(s.box)))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let r=-1/0,o=-1/0;s&&e.intersectSphere(s,qe)&&(r=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(qe)),n&&(N.copy(e).applyMatrix4(n.inverseTransform),N.intersectBox(n.box,We)&&(o=n.box.containsPoint(N.origin)?0:N.origin.distanceToSquared(We)));const a=Math.max(r,o);return a===-1/0?null:(e.at(Math.sqrt(a),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,r=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(He.copy(e).applyMatrix4(s.inverseTransform),r=s.box.distanceToPoint(He)),n>r?n:r}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsFrustum(e)?!1:!!(s||t)}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new Be;k.set(e[3],e[4],e[5]),R.set(e[6],e[7],e[8]),I.set(e[9],e[10],e[11]);const n=k.length(),r=R.length(),o=I.length();k.normalize(),R.normalize(),I.normalize(),n===0&&k.crossVectors(R,I),r===0&&R.crossVectors(k,I),o===0&&I.crossVectors(k,R),s.transform.set(k.x,R.x,I.x,e[0],k.y,R.y,I.y,e[1],k.z,R.z,I.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-r,-o),s.box.max.set(n,r,o),s.update(),this.obb=s}setSphereData(e,t,s,n,r){const o=new vt;o.center.set(e,t,s),o.radius=n,o.applyMatrix4(r),this.sphere=o}setRegionData(e,t,s,n,r,o){const a=new hs(ce,ce,qt,t,n,e,s,r,o),c=new Be;a.getBoundingBox(c.box,c.transform),c.update(),this.region=a,this.regionObb=c}}const wt=Symbol("INITIAL_FRUSTUM_CULLED"),re=new L,Ce=new L,V=new T,ds=new T(1,0,0),ps=new T(0,1,0);function $e(i,e){i.traverse(t=>{t.frustumCulled=t[wt]&&e})}class fs extends $t{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{$e(t,!e)}))}constructor(...e){super(...e),this.group=new ts(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this._autoDisableRendererCulling=!0,this.optimizeRaycast=!0,this.onLoadTileSet=null,this.onLoadModel=null,this.onDisposeModel=null,this.onTileVisibilityChange=null;const t=new Rt;t.setURLModifier(n=>this.preprocessURL?this.preprocessURL(n):n),this.manager=t;const s=this;this._overridenRaycast=function(n,r){s.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,n,r)}}getBounds(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t&&t.getAABB(e),!0}getOrientedBounds(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return s&&s.getOBB(e,t),!0}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getSphere(e),!0):!1}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached.scene;s&&e(s,t)})}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=yt(this,this.root,e);s&&t.push(s)}else Tt(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return s.has(e)?!1:(s.set(e,new Le),t.push(e),!0)}setResolution(e,t,s){const n=this.cameraMap;return n.has(e)?(t instanceof Le?n.get(e).copy(t):n.get(e).set(t,s),!0):!1}setResolutionFromRenderer(e,t){const s=this.cameraMap;if(!s.has(e))return!1;const n=s.get(e);return t.getSize(n),n.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),!0}return!1}fetchTileSet(e,...t){const s=super.fetchTileSet(e,...t);return s.then(n=>{this.onLoadTileSet&&Promise.resolve().then(()=>{this.onLoadTileSet(n,e)})}),s}update(){const e=this.group,t=this.cameras,s=this.cameraMap,n=this.cameraInfo;if(t.length===0){console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");return}for(;n.length>t.length;)n.pop();for(;n.length<t.length;)n.push({frustum:new kt,isOrthographic:!1,sseDenominator:-1,position:new T,invScale:-1,pixelSize:0});Ce.copy(e.matrixWorld).invert(),V.setFromMatrixScale(Ce);const r=V.x;Math.abs(Math.max(V.x-V.y,V.x-V.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let o=0,a=n.length;o<a;o++){const c=t[o],h=n[o],l=h.frustum,u=h.position,d=s.get(c);(d.width===0||d.height===0)&&console.warn("TilesRenderer: resolution for camera error calculation is not set.");const f=c.projectionMatrix.elements;if(h.isOrthographic=f[15]===1,h.isOrthographic){const p=2/f[0],m=2/f[5];h.pixelSize=Math.max(m/d.height,p/d.width)}else h.sseDenominator=2/f[5]/d.height;h.invScale=r,re.copy(e.matrixWorld),re.premultiply(c.matrixWorldInverse),re.premultiply(c.projectionMatrix),l.setFromProjectionMatrix(re),u.set(0,0,0),u.applyMatrix4(c.matrixWorld),u.applyMatrix4(Ce)}super.update()}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new L;if(e.transform){const a=e.transform;for(let c=0;c<16;c++)n.elements[c]=a[c]}else n.identity();s&&n.premultiply(s.cached.transform);const r=new L().copy(n).invert(),o=new us;"sphere"in e.boundingVolume&&o.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&o.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&o.setRegionData(...e.boundingVolume.region),e.cached={loadIndex:0,transform:n,transformInverse:r,active:!1,inFrustum:[],boundingVolume:o,scene:null,geometry:null,material:null}}parseTile(e,t,s){t._loadIndex=t._loadIndex||0,t._loadIndex++;const r=t.content.uri.split(/[\\\/]/g);r.pop();const o=r.join("/"),a=this.fetchOptions,c=this.manager,h=t._loadIndex;let l=null;const u=this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y",d=t.cached,f=d.transform,p=new L;switch(u.toLowerCase()){case"x":p.makeRotationAxis(ps,-Math.PI/2);break;case"y":p.makeRotationAxis(ds,Math.PI/2);break;case"z":p.identity();break}const m=(z(e)||s).toLowerCase();switch(m){case"b3dm":{const _=new pt(c);_.workingPath=o,_.fetchOptions=a,_.adjustmentTransform.copy(p),l=_.parse(e);break}case"pnts":{const _=new ft(c);_.workingPath=o,_.fetchOptions=a,l=_.parse(e);break}case"i3dm":{const _=new mt(c);_.workingPath=o,_.fetchOptions=a,_.adjustmentTransform.copy(p),l=_.parse(e);break}case"cmpt":{const _=new Xt(c);_.workingPath=o,_.fetchOptions=a,_.adjustmentTransform.copy(p),l=_.parse(e).then(b=>b.scene);break}case"gltf":case"glb":const g=new es(c);g.workingPath=o,g.fetchOptions=a,l=g.parse(e);break;default:console.warn(`TilesRenderer: Content type "${m}" not supported.`),l=Promise.resolve(null);break}return l.then(g=>{let _,b;if(g.isObject3D?(_=g,b=null):(_=g.scene,b=g),t._loadIndex!==h)return;_.updateMatrix(),(m==="glb"||m==="gltf")&&_.matrix.multiply(p),_.matrix.premultiply(f),_.matrix.decompose(_.position,_.quaternion,_.scale),_.traverse(w=>{w[wt]=w.frustumCulled}),$e(_,!this.autoDisableRendererCulling),_.traverse(w=>{w.raycast=this._overridenRaycast});const S=[],x=[],E=[];_.traverse(w=>{if(w.geometry&&x.push(w.geometry),w.material){const y=w.material;S.push(w.material);for(const A in y){const M=y[A];M&&M.isTexture&&E.push(M)}}}),d.materials=S,d.geometry=x,d.textures=E,d.scene=_,d.metadata=b,this.onLoadModel&&this.onLoadModel(_,t)})}disposeTile(e){const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,r=t.textures,o=t.scene.parent;for(let a=0,c=n.length;a<c;a++)n[a].dispose();for(let a=0,c=s.length;a<c;a++)s[a].dispose();for(let a=0,c=r.length;a<c;a++)r[a].dispose();o&&o.remove(t.scene),this.onDisposeModel&&this.onDisposeModel(t.scene,e),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}this.activeTiles.delete(e),this.visibleTiles.delete(e),e._loadIndex++}setTileVisible(e,t){const s=e.cached.scene,n=this.visibleTiles,r=this.group;t?(r.add(s),n.add(e),s.updateMatrixWorld(!0)):(r.remove(s),n.delete(e)),this.onTileVisibilityChange&&this.onTileVisibilityChange(s,e,t)}setTileActive(e,t){const s=this.activeTiles;t?s.add(e):s.delete(e)}calculateError(e){const t=e.cached,s=t.inFrustum,n=this.cameras,r=this.cameraInfo,o=t.boundingVolume;let a=-1/0,c=1/0;for(let h=0,l=n.length;h<l;h++){if(!s[h])continue;const u=r[h],d=u.invScale;let f;if(u.isOrthographic){const p=u.pixelSize;f=e.geometricError/(p*d)}else{const m=o.distanceToPoint(u.position)*d,g=u.sseDenominator;f=e.geometricError/(m*g),c=Math.min(c,m)}a=Math.max(a,f)}e.__distanceFromCamera=c,e.__error=a}tileInView(e){const t=e.cached,s=t.boundingVolume,n=t.inFrustum,r=this.cameraInfo;let o=!1;for(let a=0,c=r.length;a<c;a++){const h=r[a].frustum;s.intersectsFrustum(h)?(o=!0,n[a]=!0):n[a]=!1}return o}}class ms{constructor(){this._listeners={}}on(e,t,s){this._listeners[e]?this._listeners[e].push({callback:t,isOnce:s}):this._listeners[e]=[{callback:t,isOnce:s}]}off(e,t){if(!t)throw new Error("取消事件时需要传入原回调函数");const s=this._listeners[e];if(s&&s.length>0){for(let n=0;n<s.length;n++)if(s[n].callback===t){s.splice(n,1);break}}}emit(e,t){const s=this._listeners[e];if(s&&s.length>0)for(let n=0;n<s.length;n++){const r=s[n];r.callback.call(this,t),r.isOnce&&(s.splice(n,1),n--)}}}class gs extends fs{preprocessNode(e,t,s){if(e.transform&&!s){const n=new L().fromArray(e.transform),r=new T,o=new T,a=new Xe;n.decompose(r,a,o),a.setFromAxisAngle(new T(0,0,1),0),n.compose(r,a,o),e.transform=n.toArray()}super.preprocessNode(e,t,s)}}const C=3.141592653589793,Je=6378245,Qe=.006693421622965943;function _s(i,e){let t=-100+2*i+3*e+.2*e*e+.1*i*e+.2*Math.sqrt(Math.abs(i));return t+=(20*Math.sin(6*i*C)+20*Math.sin(2*i*C))*2/3,t+=(20*Math.sin(e*C)+40*Math.sin(e/3*C))*2/3,t+=(160*Math.sin(e/12*C)+320*Math.sin(e*C/30))*2/3,t}function bs(i,e){let t=300+i+2*e+.1*i*i+.1*i*e+.1*Math.sqrt(Math.abs(i));return t+=(20*Math.sin(6*i*C)+20*Math.sin(2*i*C))*2/3,t+=(20*Math.sin(i*C)+40*Math.sin(i/3*C))*2/3,t+=(150*Math.sin(i/12*C)+300*Math.sin(i/30*C))*2/3,t}function ys(i,e){return i<72.004||i>137.8347||e<.8293||e>55.8271}function Ts(i,e){if(ys(i,e))return[i,e];let t=_s(i-105,e-35),s=bs(i-105,e-35),n=e/180*C,r=Math.sin(n);r=1-Qe*r*r;let o=Math.sqrt(r);t=t*180/(Je*(1-Qe)/(r*o)*C),s=s*180/(Je/o*Math.cos(n)*C);let a=Ye(e+t);return[Ye(i+s),a]}function Ye(i){return parseFloat(i.toFixed(6))}function ws(i,e,t){const s=63567523142e-4,n=(6378137-s)/6378137,r=Math.sqrt(2*n-n*n),o=r*r,a=Math.sqrt(i*i+e*e),c=Math.atan2(t*6378137,a*s),h=Math.sin(c),l=Math.cos(c),u=Math.atan2(t+o*s*h*h*h,a-o*6378137*l*l*l),d=Math.atan2(e,i),f=a/Math.cos(u)-6378137/Math.sqrt(1-o*Math.sin(u)*Math.sin(u)),p=u*180/Math.PI,m=d*180/Math.PI;return{latitude:p,longitude:m,height:f}}class Ss extends ms{constructor(e,t){super(),this.animationFrame=-1,this.hasResetCenter=!1,this.options=t,this.mouse=new Le,this.layer=e;const s=new gs(t.url);s.setCamera(this.layer.getCamera()),s.setResolutionFromRenderer(this.layer.getCamera(),this.layer.getRender());const n=t.fetchOptions||{},r=new he(s.manager);n.credentials==="include"&&n.mode==="cors"&&r.setCrossOrigin("use-credentials"),"credentials"in n&&r.setWithCredentials(n.credentials==="include"),n.headers&&r.setRequestHeader(n.headers);const o=new Vt,a=t.dracoDecoderPath||"https://cdn.jsdelivr.net/npm/three@0.143/examples/js/libs/draco/";o.setDecoderPath(a),r.setDRACOLoader(o),t.configLoader&&t.configLoader(r),s.manager.addHandler(/\.gltf$/i,r),s.onLoadTileSet=h=>{this.emit("loadTileSet",h)},s.onLoadModel=(h,l)=>{this.emit("loadModel",{scene:h,tile:l})},s.onDisposeModel=(h,l)=>{this.emit("disposeModel",{scene:h,tile:l})},s.downloadQueue.maxJobs=6,s.parseQueue.maxJobs=6;const c=new ie;if(this.parentGroup=new ie,this.parentGroup.add(s.group),c.add(this.parentGroup),this.group=c,this.layer.add(this.group),this.tilesRenderer=s,t.position&&this.setPosition(t.position),t.rotation&&this.setRotation(t.rotation),t.translate&&this.setTranslate(t.translate),t.scale&&this.setScale(t.scale),this.animate(),t.debug){const h=document.createElement("div");h.style.position="absolute",h.style.top="0px",h.style.left="0px",h.style.color="white",h.style.width="100%",h.style.textAlign="center",h.style.padding="5px",h.style.pointerEvents="none",h.style.lineHeight="1.5em",document.body.appendChild(h),this.statsContainer=h}this.bindEvents(t.mouseEvent)}bindEvents(e){if(e){this.raycaster=new It,this.raycaster.firstHitOnly=!0;const t=this.layer.getMap();this.clickMapFn=de(this.clickMap,this),t.on("click",this.clickMapFn),this.mousemoveMapFn=de(this.mousemoveMap,this),t.on("mousemove",this.mousemoveMapFn),this.rightClickMapFn=de(this.rightClickMap,this),t.on("rightclick",this.rightClickMapFn)}}unbindEvents(){const e=this.layer.getMap();this.clickMapFn&&(e.off("click",this.clickMapFn),this.clickMapFn=null),this.mousemoveMapFn&&(e.off("mousemove",this.mousemoveMapFn),this.mousemoveMapFn=null),this.rightClickMapFn&&(e.off("rightclick",this.rightClickMapFn),this.rightClickMapFn=null),this.tilesRenderer&&(this.tilesRenderer.onLoadTileSet=null,this.tilesRenderer.onLoadModel=null,this.tilesRenderer.onDisposeModel=null)}clickMap(e){const t=this._intersectGltf(e);this.emit("click",t)}mousemoveMap(e){const t=this._intersectGltf(e);this.emit("mousemove",t)}rightClickMap(e){const t=this._intersectGltf(e);this.emit("rightClick",t)}_intersectGltf(e){var t,s;const n=this.layer.getMap().getContainer().getBoundingClientRect(),r=this.mouse;r.x=e.originEvent.clientX-n.x,r.y=e.originEvent.clientY-n.y,r.x=r.x/n.width*2-1,r.y=-(r.y/n.height)*2+1;const o=this.layer.getCamera();(t=this.raycaster)===null||t===void 0||t.setFromCamera(r,o);const a=(s=this.raycaster)===null||s===void 0?void 0:s.intersectObject(this.group,!0);if(a!=null&&a.length){const c=a[0].object,h={},l=this.getBatchTable(c);return l&&l.getKeys().forEach(u=>{h[u]=l.getData(u)}),{object:c,batchData:h}}return null}getBatchTable(e){return e?e.batchTable?e.batchTable:this.getBatchTable(e.parent):null}setPosition(e){const t=this.layer.convertLngLat(e);this.group.position.setX(t[0]),this.group.position.setY(t[1]),this.refresh(),this.position=e}setRotation(e){if(e){const t=Math.PI/180*(e.x||0),s=Math.PI/180*(e.y||0),n=Math.PI/180*(e.z||0);this.group.rotation.set(t,s,n),this.refresh()}}setTranslate(e){e&&(this.group.translateX(e.x),this.group.translateY(e.y),this.group.translateZ(e.z),this.refresh())}setScale(e){let t;typeof e=="number"?t={x:e,y:e,z:e}:t=e,this.group.scale.set(t.x,t.y,t.z),this.refresh()}refresh(){this.layer.update()}show(){this.group.visible=!0,this.refresh()}hide(){this.group.visible=!1,this.refresh()}animate(){this.animationFrame=requestAnimationFrame(()=>{if(this.update(),this.animate(),!this.hasResetCenter&&this.tilesRenderer.root){const e=new et;this.tilesRenderer.root&&this.tilesRenderer.root.boundingVolume.region&&(this.tilesRenderer.getOrientedBounds(e,this.parentGroup.matrix),this.parentGroup.matrix.decompose(this.parentGroup.position,this.parentGroup.quaternion,this.parentGroup.scale),this.parentGroup.position.set(0,0,0),this.parentGroup.quaternion.invert(),this.parentGroup.scale.set(1,1,1)),this.group.updateMatrixWorld(!1),this.tilesRenderer.getBounds(e)&&(this.resetPosition(e),e.getCenter(this.tilesRenderer.group.position),this.tilesRenderer.group.position.multiplyScalar(-1),this.hasResetCenter=!0)}})}resetPosition(e){if(!this.position){const t=new T;e.getCenter(t);const s=ws(t.x,t.y,t.z),n=Ts(s.longitude,s.latitude);this.options.autoFocus&&this.layer.getMap().setCenter(n),this.setPosition(n)}}update(){var e;if(this.layer.getCamera().updateMatrixWorld(),(e=this.tilesRenderer)===null||e===void 0||e.update(),this.layer.update(),this.statsContainer){const t=this.tilesRenderer;this.statsContainer.innerHTML=`正在下载: ${t.stats.downloading} 正在编译: ${t.stats.parsing} 已显示: ${t.group.children.length}`}}getGroup(){return this.group}getTilesRenderer(){return this.tilesRenderer}destroy(){var e;cancelAnimationFrame(this.animationFrame),this.unbindEvents(),this.layer.remove(this.group),(e=this.tilesRenderer)===null||e===void 0||e.dispose(),this.group=null,this.layer=null,this.statsContainer&&(this.statsContainer.remove(),this.statsContainer=void 0)}}const xs=tt({name:"ElAmapThreeTiles3d",inheritAttrs:!1,__name:"ThreeTiles3d",props:Ut({url:{type:String,required:!0},position:{type:Object},scale:{type:Object},rotation:{type:Object},translate:{type:Object},dracoDecoderPath:{type:String},fetchOptions:{type:Object},mouseEvent:{type:Boolean,default:!1},debug:{type:Boolean,default:!1},autoFocus:{type:Boolean,default:!1},configLoader:{type:Function}}),emits:["init"],setup(i,{expose:e,emit:t}){const s=t;let n;const{$$getInstance:r,parentInstance:o}=Bt((c,h)=>new Promise(l=>{n=new Ss(h,c),l(n)}),{emits:s,destroyComponent(){n&&(o!=null&&o.$amapComponent)&&(n.destroy(),n=null)}});e({$$getInstance:r});const a={emits:s,get $amapComponent(){return n},set $amapComponent(c){n=c},$$getInstance:r,parentInstance:o};return Object.defineProperty(a,"__isScriptSetup",{enumerable:!1,value:!0}),a}});function Cs(i,e,t,s,n,r){return Me(),nt("div")}const oe=st(xs,[["render",Cs],["__file","ThreeTiles3d.vue"]]);oe.install=i=>(i.component(oe.name,oe),i);const Ls=oe,Ms="https://raw.githubusercontent.com/yangyanggu/layer-3dtiles/master/test/hutong/tileset.json",Es=tt({__name:"three-tiles3d",setup(i,{expose:e}){e();const t=Q(16),s=Q([116.404987,39.90946]),n=Q(!0),r=()=>{n.value=!n.value},o=u=>{console.log("click map: ",u)},a=u=>{console.log("init map: ",u)},c=Q(!0),l={zoom:t,center:s,url:Ms,visible:n,changeVisible:r,clickMap:o,initMap:a,create:c,changeCreate:()=>{c.value=!c.value},get ElAmap(){return Nt},get ElAmapLayerThree(){return xt},get ElAmapThreeLightAmbient(){return Ct},get ElAmapThreeTiles3d(){return Ls}};return Object.defineProperty(l,"__isScriptSetup",{enumerable:!1,value:!0}),l}}),As={class:"map-page-container"},Ps={class:"toolbar"};function vs(i,e,t,s,n,r){return Me(),nt(Dt,null,[Y("div",As,[pe(s.ElAmap,{"show-label":!1,center:s.center,zoom:s.zoom,"view-mode":"3D",pitch:60,"show-building-block":!1,features:["bg","road"],onClick:s.clickMap,onInit:s.initMap},{default:ve(()=>[pe(s.ElAmapLayerThree,null,{default:ve(()=>[pe(s.ElAmapThreeLightAmbient,{color:"rgb(255,255,255)",intensity:1}),s.create?(Me(),Ot(s.ElAmapThreeTiles3d,{key:0,visible:s.visible,debug:!0,"auto-focus":"",url:s.url},null,8,["visible"])):Ft("",!0)]),_:1})]),_:1},8,["center","zoom"])]),Y("div",Ps,[Y("button",{onClick:s.changeVisible},ke(s.visible?"隐藏":"显示"),1),Y("button",{onClick:s.changeCreate},ke(s.create?"销毁":"创建"),1)])],64)}const Ds=st(Es,[["render",vs],["__file","three-tiles3d.vue"]]);export{Ds as default};
