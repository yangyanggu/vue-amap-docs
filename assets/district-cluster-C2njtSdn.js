import{b as Wt,u as Ut,E as Ht}from"./index-XVBT3eyP.js";import{p as Ct,_ as Dt,o as Ot,c as Tt,f as j,m as Yt,a as Y,d as ft,w as Xt,ao as Jt,al as Qt}from"./app-BIv4BGsj.js";var Bt={};class lt{constructor(){this._listeners={}}on(t,e,r){this._listeners[t]?this._listeners[t].push({callback:e,isOnce:r}):this._listeners[t]=[{callback:e,isOnce:r}]}off(t,e){if(!e)throw new Error("取消事件时需要传入原回调函数");const r=this._listeners[t];if(r&&r.length>0){for(let i=0;i<r.length;i++)if(r[i].callback===e){r.splice(i,1);break}}}emit(t,...e){const r=this._listeners[t];if(r&&r.length>0)for(let n=0;n<r.length;n++){const s=r[n];s.callback.call(this,...e),s.isOnce&&(r.splice(n,1),n--)}const i=this._listeners["*"];if(i&&i.length>0)for(let n=0;n<i.length;n++){const s=i[n];s.callback.call(this,t,...e),s.isOnce&&(i.splice(n,1),n--)}}trigger(t,...e){this.emit(t,e)}}function zt(o,t,e){e===void 0&&(e={});var r={type:"Feature"};return(e.id===0||e.id)&&(r.id=e.id),e.bbox&&(r.bbox=e.bbox),r.properties=t||{},r.geometry=o,r}function tt(o,t,e){e===void 0&&(e={});for(var r=0,i=o;r<i.length;r++){var n=i[r];if(n.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var s=0;s<n[n.length-1].length;s++)if(n[n.length-1][s]!==n[0][s])throw new Error("First and last Position are not equivalent.")}var a={type:"Polygon",coordinates:o};return zt(a,t,e)}function Kt(o,t,e){e===void 0&&(e={});var r={type:"MultiPolygon",coordinates:o};return zt(r,t,e)}function gt(o){return o.type==="Feature"?o.geometry:o}/**
* splaytree v3.1.1
* Fast Splay tree for Node and browser
*
* @author Alexander Milevski <info@w8r.name>
* @license MIT
* @preserve
*//*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function te(o,t){var e={label:0,sent:function(){if(n[0]&1)throw n[1];return n[1]},trys:[],ops:[]},r,i,n,s;return s={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(u){return function(h){return l([u,h])}}function l(u){if(r)throw new TypeError("Generator is already executing.");for(;e;)try{if(r=1,i&&(n=u[0]&2?i.return:u[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,u[1])).done)return n;switch(i=0,n&&(u=[u[0]&2,n.value]),u[0]){case 0:case 1:n=u;break;case 4:return e.label++,{value:u[1],done:!1};case 5:e.label++,i=u[1],u=[0];continue;case 7:u=e.ops.pop(),e.trys.pop();continue;default:if(n=e.trys,!(n=n.length>0&&n[n.length-1])&&(u[0]===6||u[0]===2)){e=0;continue}if(u[0]===3&&(!n||u[1]>n[0]&&u[1]<n[3])){e.label=u[1];break}if(u[0]===6&&e.label<n[1]){e.label=n[1],n=u;break}if(n&&e.label<n[2]){e.label=n[2],e.ops.push(u);break}n[2]&&e.ops.pop(),e.trys.pop();continue}u=t.call(o,e)}catch(h){u=[6,h],i=0}finally{r=n=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}var P=function(){function o(t,e){this.next=null,this.key=t,this.data=e,this.left=null,this.right=null}return o}();function ee(o,t){return o>t?1:o<t?-1:0}function A(o,t,e){for(var r=new P(null,null),i=r,n=r;;){var s=e(o,t.key);if(s<0){if(t.left===null)break;if(e(o,t.left.key)<0){var a=t.left;if(t.left=a.right,a.right=t,t=a,t.left===null)break}n.left=t,n=t,t=t.left}else if(s>0){if(t.right===null)break;if(e(o,t.right.key)>0){var a=t.right;if(t.right=a.left,a.left=t,t=a,t.right===null)break}i.right=t,i=t,t=t.right}else break}return i.right=t.left,n.left=t.right,t.left=r.right,t.right=r.left,t}function X(o,t,e,r){var i=new P(o,t);if(e===null)return i.left=i.right=null,i;e=A(o,e,r);var n=r(o,e.key);return n<0?(i.left=e.left,i.right=e,e.left=null):n>=0&&(i.right=e.right,i.left=e,e.right=null),i}function yt(o,t,e){var r=null,i=null;if(t){t=A(o,t,e);var n=e(t.key,o);n===0?(r=t.left,i=t.right):n<0?(i=t.right,t.right=null,r=t):(r=t.left,t.left=null,i=t)}return{left:r,right:i}}function re(o,t,e){return t===null?o:(o===null||(t=A(o.key,t,e),t.left=o),t)}function et(o,t,e,r,i){if(o){r(""+t+(e?"└── ":"├── ")+i(o)+`
`);var n=t+(e?"    ":"│   ");o.left&&et(o.left,n,!1,r,i),o.right&&et(o.right,n,!0,r,i)}}var ut=function(){function o(t){t===void 0&&(t=ee),this._root=null,this._size=0,this._comparator=t}return o.prototype.insert=function(t,e){return this._size++,this._root=X(t,e,this._root,this._comparator)},o.prototype.add=function(t,e){var r=new P(t,e);this._root===null&&(r.left=r.right=null,this._size++,this._root=r);var i=this._comparator,n=A(t,this._root,i),s=i(t,n.key);return s===0?this._root=n:(s<0?(r.left=n.left,r.right=n,n.left=null):s>0&&(r.right=n.right,r.left=n,n.right=null),this._size++,this._root=r),this._root},o.prototype.remove=function(t){this._root=this._remove(t,this._root,this._comparator)},o.prototype._remove=function(t,e,r){var i;if(e===null)return null;e=A(t,e,r);var n=r(t,e.key);return n===0?(e.left===null?i=e.right:(i=A(t,e.left,r),i.right=e.right),this._size--,i):e},o.prototype.pop=function(){var t=this._root;if(t){for(;t.left;)t=t.left;return this._root=A(t.key,this._root,this._comparator),this._root=this._remove(t.key,this._root,this._comparator),{key:t.key,data:t.data}}return null},o.prototype.findStatic=function(t){for(var e=this._root,r=this._comparator;e;){var i=r(t,e.key);if(i===0)return e;i<0?e=e.left:e=e.right}return null},o.prototype.find=function(t){return this._root&&(this._root=A(t,this._root,this._comparator),this._comparator(t,this._root.key)!==0)?null:this._root},o.prototype.contains=function(t){for(var e=this._root,r=this._comparator;e;){var i=r(t,e.key);if(i===0)return!0;i<0?e=e.left:e=e.right}return!1},o.prototype.forEach=function(t,e){for(var r=this._root,i=[],n=!1;!n;)r!==null?(i.push(r),r=r.left):i.length!==0?(r=i.pop(),t.call(e,r),r=r.right):n=!0;return this},o.prototype.range=function(t,e,r,i){for(var n=[],s=this._comparator,a=this._root,l;n.length!==0||a;)if(a)n.push(a),a=a.left;else{if(a=n.pop(),l=s(a.key,e),l>0)break;if(s(a.key,t)>=0&&r.call(i,a))return this;a=a.right}return this},o.prototype.keys=function(){var t=[];return this.forEach(function(e){var r=e.key;return t.push(r)}),t},o.prototype.values=function(){var t=[];return this.forEach(function(e){var r=e.data;return t.push(r)}),t},o.prototype.min=function(){return this._root?this.minNode(this._root).key:null},o.prototype.max=function(){return this._root?this.maxNode(this._root).key:null},o.prototype.minNode=function(t){if(t===void 0&&(t=this._root),t)for(;t.left;)t=t.left;return t},o.prototype.maxNode=function(t){if(t===void 0&&(t=this._root),t)for(;t.right;)t=t.right;return t},o.prototype.at=function(t){for(var e=this._root,r=!1,i=0,n=[];!r;)if(e)n.push(e),e=e.left;else if(n.length>0){if(e=n.pop(),i===t)return e;i++,e=e.right}else r=!0;return null},o.prototype.next=function(t){var e=this._root,r=null;if(t.right){for(r=t.right;r.left;)r=r.left;return r}for(var i=this._comparator;e;){var n=i(t.key,e.key);if(n===0)break;n<0?(r=e,e=e.left):e=e.right}return r},o.prototype.prev=function(t){var e=this._root,r=null;if(t.left!==null){for(r=t.left;r.right;)r=r.right;return r}for(var i=this._comparator;e;){var n=i(t.key,e.key);if(n===0)break;n<0?e=e.left:(r=e,e=e.right)}return r},o.prototype.clear=function(){return this._root=null,this._size=0,this},o.prototype.toList=function(){return ne(this._root)},o.prototype.load=function(t,e,r){e===void 0&&(e=[]),r===void 0&&(r=!1);var i=t.length,n=this._comparator;if(r&&nt(t,e,0,i-1,n),this._root===null)this._root=rt(t,e,0,i),this._size=i;else{var s=oe(this.toList(),ie(t,e),n);i=this._size+i,this._root=it({head:s},0,i)}return this},o.prototype.isEmpty=function(){return this._root===null},Object.defineProperty(o.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"root",{get:function(){return this._root},enumerable:!0,configurable:!0}),o.prototype.toString=function(t){t===void 0&&(t=function(r){return String(r.key)});var e=[];return et(this._root,"",!0,function(r){return e.push(r)},t),e.join("")},o.prototype.update=function(t,e,r){var i=this._comparator,n=yt(t,this._root,i),s=n.left,a=n.right;i(t,e)<0?a=X(e,r,a,i):s=X(e,r,s,i),this._root=re(s,a,i)},o.prototype.split=function(t){return yt(t,this._root,this._comparator)},o.prototype[Symbol.iterator]=function(){var t;return te(this,function(e){switch(e.label){case 0:t=this.minNode(),e.label=1;case 1:return t?[4,t]:[3,3];case 2:return e.sent(),t=this.next(t),[3,1];case 3:return[2]}})},o}();function rt(o,t,e,r){var i=r-e;if(i>0){var n=e+Math.floor(i/2),s=o[n],a=t[n],l=new P(s,a);return l.left=rt(o,t,e,n),l.right=rt(o,t,n+1,r),l}return null}function ie(o,t){for(var e=new P(null,null),r=e,i=0;i<o.length;i++)r=r.next=new P(o[i],t[i]);return r.next=null,e.next}function ne(o){for(var t=o,e=[],r=!1,i=new P(null,null),n=i;!r;)t?(e.push(t),t=t.left):e.length>0?(t=n=n.next=e.pop(),t=t.right):r=!0;return n.next=null,i.next}function it(o,t,e){var r=e-t;if(r>0){var i=t+Math.floor(r/2),n=it(o,t,i),s=o.head;return s.left=n,o.head=o.head.next,s.right=it(o,i+1,e),s}return null}function oe(o,t,e){for(var r=new P(null,null),i=r,n=o,s=t;n!==null&&s!==null;)e(n.key,s.key)<0?(i.next=n,n=n.next):(i.next=s,s=s.next),i=i.next;return n!==null?i.next=n:s!==null&&(i.next=s),r.next}function nt(o,t,e,r,i){if(!(e>=r)){for(var n=o[e+r>>1],s=e-1,a=r+1;;){do s++;while(i(o[s],n)<0);do a--;while(i(o[a],n)>0);if(s>=a)break;var l=o[s];o[s]=o[a],o[a]=l,l=t[s],t[s]=t[a],t[a]=l}nt(o,t,e,a,i),nt(o,t,a+1,r,i)}}function S(o,t){if(!(o instanceof t))throw new TypeError("Cannot call a class as a function")}function _t(o,t){for(var e=0;e<t.length;e++){var r=t[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(o,r.key,r)}}function b(o,t,e){return t&&_t(o.prototype,t),e&&_t(o,e),o}var z=function(o,t){return o.ll.x<=t.x&&t.x<=o.ur.x&&o.ll.y<=t.y&&t.y<=o.ur.y},ot=function(o,t){if(t.ur.x<o.ll.x||o.ur.x<t.ll.x||t.ur.y<o.ll.y||o.ur.y<t.ll.y)return null;var e=o.ll.x<t.ll.x?t.ll.x:o.ll.x,r=o.ur.x<t.ur.x?o.ur.x:t.ur.x,i=o.ll.y<t.ll.y?t.ll.y:o.ll.y,n=o.ur.y<t.ur.y?o.ur.y:t.ur.y;return{ll:{x:e,y:i},ur:{x:r,y:n}}},I=Number.EPSILON;I===void 0&&(I=Math.pow(2,-52));var se=I*I,st=function(o,t){if(-I<o&&o<I&&-I<t&&t<I)return 0;var e=o-t;return e*e<se*o*t?0:o<t?-1:1},ae=function(){function o(){S(this,o),this.reset()}return b(o,[{key:"reset",value:function(){this.xRounder=new mt,this.yRounder=new mt}},{key:"round",value:function(t,e){return{x:this.xRounder.round(t),y:this.yRounder.round(e)}}}]),o}(),mt=function(){function o(){S(this,o),this.tree=new ut,this.round(0)}return b(o,[{key:"round",value:function(t){var e=this.tree.add(t),r=this.tree.prev(e);if(r!==null&&st(e.key,r.key)===0)return this.tree.remove(t),r.key;var i=this.tree.next(e);return i!==null&&st(e.key,i.key)===0?(this.tree.remove(t),i.key):t}}]),o}(),Z=new ae,G=function(o,t){return o.x*t.y-o.y*t.x},Gt=function(o,t){return o.x*t.x+o.y*t.y},vt=function(o,t,e){var r={x:t.x-o.x,y:t.y-o.y},i={x:e.x-o.x,y:e.y-o.y},n=G(r,i);return st(n,0)},q=function(o){return Math.sqrt(Gt(o,o))},le=function(o,t,e){var r={x:t.x-o.x,y:t.y-o.y},i={x:e.x-o.x,y:e.y-o.y};return G(i,r)/q(i)/q(r)},ue=function(o,t,e){var r={x:t.x-o.x,y:t.y-o.y},i={x:e.x-o.x,y:e.y-o.y};return Gt(i,r)/q(i)/q(r)},bt=function(o,t,e){return t.y===0?null:{x:o.x+t.x/t.y*(e-o.y),y:e}},xt=function(o,t,e){return t.x===0?null:{x:e,y:o.y+t.y/t.x*(e-o.x)}},he=function(o,t,e,r){if(t.x===0)return xt(e,r,o.x);if(r.x===0)return xt(o,t,e.x);if(t.y===0)return bt(e,r,o.y);if(r.y===0)return bt(o,t,e.y);var i=G(t,r);if(i==0)return null;var n={x:e.x-o.x,y:e.y-o.y},s=G(n,t)/i,a=G(n,r)/i,l=o.x+a*t.x,u=e.x+s*r.x,h=o.y+a*t.y,c=e.y+s*r.y,d=(l+u)/2,p=(h+c)/2;return{x:d,y:p}},L=function(){b(o,null,[{key:"compare",value:function(t,e){var r=o.comparePoints(t.point,e.point);return r!==0?r:(t.point!==e.point&&t.link(e),t.isLeft!==e.isLeft?t.isLeft?1:-1:W.compare(t.segment,e.segment))}},{key:"comparePoints",value:function(t,e){return t.x<e.x?-1:t.x>e.x?1:t.y<e.y?-1:t.y>e.y?1:0}}]);function o(t,e){S(this,o),t.events===void 0?t.events=[this]:t.events.push(this),this.point=t,this.isLeft=e}return b(o,[{key:"link",value:function(t){if(t.point===this.point)throw new Error("Tried to link already linked events");for(var e=t.point.events,r=0,i=e.length;r<i;r++){var n=e[r];this.point.events.push(n),n.point=this.point}this.checkForConsuming()}},{key:"checkForConsuming",value:function(){for(var t=this.point.events.length,e=0;e<t;e++){var r=this.point.events[e];if(r.segment.consumedBy===void 0)for(var i=e+1;i<t;i++){var n=this.point.events[i];n.consumedBy===void 0&&r.otherSE.point.events===n.otherSE.point.events&&r.segment.consume(n.segment)}}}},{key:"getAvailableLinkedEvents",value:function(){for(var t=[],e=0,r=this.point.events.length;e<r;e++){var i=this.point.events[e];i!==this&&!i.segment.ringOut&&i.segment.isInResult()&&t.push(i)}return t}},{key:"getLeftmostComparator",value:function(t){var e=this,r=new Map,i=function(n){var s=n.otherSE;r.set(n,{sine:le(e.point,t.point,s.point),cosine:ue(e.point,t.point,s.point)})};return function(n,s){r.has(n)||i(n),r.has(s)||i(s);var a=r.get(n),l=a.sine,u=a.cosine,h=r.get(s),c=h.sine,d=h.cosine;return l>=0&&c>=0?u<d?1:u>d?-1:0:l<0&&c<0?u<d?-1:u>d?1:0:c<l?-1:c>l?1:0}}}]),o}(),ce=0,W=function(){b(o,null,[{key:"compare",value:function(t,e){var r=t.leftSE.point.x,i=e.leftSE.point.x,n=t.rightSE.point.x,s=e.rightSE.point.x;if(s<r)return 1;if(n<i)return-1;var a=t.leftSE.point.y,l=e.leftSE.point.y,u=t.rightSE.point.y,h=e.rightSE.point.y;if(r<i){if(l<a&&l<u)return 1;if(l>a&&l>u)return-1;var c=t.comparePoint(e.leftSE.point);if(c<0)return 1;if(c>0)return-1;var d=e.comparePoint(t.rightSE.point);return d!==0?d:-1}if(r>i){if(a<l&&a<h)return-1;if(a>l&&a>h)return 1;var p=e.comparePoint(t.leftSE.point);if(p!==0)return p;var f=t.comparePoint(e.rightSE.point);return f<0?1:f>0?-1:1}if(a<l)return-1;if(a>l)return 1;if(n<s){var g=e.comparePoint(t.rightSE.point);if(g!==0)return g}if(n>s){var m=t.comparePoint(e.rightSE.point);if(m<0)return 1;if(m>0)return-1}if(n!==s){var v=u-a,x=n-r,_=h-l,k=s-i;if(v>x&&_<k)return 1;if(v<x&&_>k)return-1}return n>s?1:n<s||u<h?-1:u>h?1:t.id<e.id?-1:t.id>e.id?1:0}}]);function o(t,e,r,i){S(this,o),this.id=++ce,this.leftSE=t,t.segment=this,t.otherSE=e,this.rightSE=e,e.segment=this,e.otherSE=t,this.rings=r,this.windings=i}return b(o,[{key:"replaceRightSE",value:function(t){this.rightSE=t,this.rightSE.segment=this,this.rightSE.otherSE=this.leftSE,this.leftSE.otherSE=this.rightSE}},{key:"bbox",value:function(){var t=this.leftSE.point.y,e=this.rightSE.point.y;return{ll:{x:this.leftSE.point.x,y:t<e?t:e},ur:{x:this.rightSE.point.x,y:t>e?t:e}}}},{key:"vector",value:function(){return{x:this.rightSE.point.x-this.leftSE.point.x,y:this.rightSE.point.y-this.leftSE.point.y}}},{key:"isAnEndpoint",value:function(t){return t.x===this.leftSE.point.x&&t.y===this.leftSE.point.y||t.x===this.rightSE.point.x&&t.y===this.rightSE.point.y}},{key:"comparePoint",value:function(t){if(this.isAnEndpoint(t))return 0;var e=this.leftSE.point,r=this.rightSE.point,i=this.vector();if(e.x===r.x)return t.x===e.x?0:t.x<e.x?1:-1;var n=(t.y-e.y)/i.y,s=e.x+n*i.x;if(t.x===s)return 0;var a=(t.x-e.x)/i.x,l=e.y+a*i.y;return t.y===l?0:t.y<l?-1:1}},{key:"getIntersection",value:function(t){var e=this.bbox(),r=t.bbox(),i=ot(e,r);if(i===null)return null;var n=this.leftSE.point,s=this.rightSE.point,a=t.leftSE.point,l=t.rightSE.point,u=z(e,a)&&this.comparePoint(a)===0,h=z(r,n)&&t.comparePoint(n)===0,c=z(e,l)&&this.comparePoint(l)===0,d=z(r,s)&&t.comparePoint(s)===0;if(h&&u)return d&&!c?s:!d&&c?l:null;if(h)return c&&n.x===l.x&&n.y===l.y?null:n;if(u)return d&&s.x===a.x&&s.y===a.y?null:a;if(d&&c)return null;if(d)return s;if(c)return l;var p=he(n,this.vector(),a,t.vector());return p===null||!z(i,p)?null:Z.round(p.x,p.y)}},{key:"split",value:function(t){var e=[],r=t.events!==void 0,i=new L(t,!0),n=new L(t,!1),s=this.rightSE;this.replaceRightSE(n),e.push(n),e.push(i);var a=new o(i,s,this.rings.slice(),this.windings.slice());return L.comparePoints(a.leftSE.point,a.rightSE.point)>0&&a.swapEvents(),L.comparePoints(this.leftSE.point,this.rightSE.point)>0&&this.swapEvents(),r&&(i.checkForConsuming(),n.checkForConsuming()),e}},{key:"swapEvents",value:function(){var t=this.rightSE;this.rightSE=this.leftSE,this.leftSE=t,this.leftSE.isLeft=!0,this.rightSE.isLeft=!1;for(var e=0,r=this.windings.length;e<r;e++)this.windings[e]*=-1}},{key:"consume",value:function(t){for(var e=this,r=t;e.consumedBy;)e=e.consumedBy;for(;r.consumedBy;)r=r.consumedBy;var i=o.compare(e,r);if(i!==0){if(i>0){var n=e;e=r,r=n}if(e.prev===r){var s=e;e=r,r=s}for(var a=0,l=r.rings.length;a<l;a++){var u=r.rings[a],h=r.windings[a],c=e.rings.indexOf(u);c===-1?(e.rings.push(u),e.windings.push(h)):e.windings[c]+=h}r.rings=null,r.windings=null,r.consumedBy=e,r.leftSE.consumedBy=e.leftSE,r.rightSE.consumedBy=e.rightSE}}},{key:"prevInResult",value:function(){return this._prevInResult!==void 0?this._prevInResult:(this.prev?this.prev.isInResult()?this._prevInResult=this.prev:this._prevInResult=this.prev.prevInResult():this._prevInResult=null,this._prevInResult)}},{key:"beforeState",value:function(){if(this._beforeState!==void 0)return this._beforeState;if(!this.prev)this._beforeState={rings:[],windings:[],multiPolys:[]};else{var t=this.prev.consumedBy||this.prev;this._beforeState=t.afterState()}return this._beforeState}},{key:"afterState",value:function(){if(this._afterState!==void 0)return this._afterState;var t=this.beforeState();this._afterState={rings:t.rings.slice(0),windings:t.windings.slice(0),multiPolys:[]};for(var e=this._afterState.rings,r=this._afterState.windings,i=this._afterState.multiPolys,n=0,s=this.rings.length;n<s;n++){var a=this.rings[n],l=this.windings[n],u=e.indexOf(a);u===-1?(e.push(a),r.push(l)):r[u]+=l}for(var h=[],c=[],d=0,p=e.length;d<p;d++)if(r[d]!==0){var f=e[d],g=f.poly;if(c.indexOf(g)===-1)if(f.isExterior)h.push(g);else{c.indexOf(g)===-1&&c.push(g);var m=h.indexOf(f.poly);m!==-1&&h.splice(m,1)}}for(var v=0,x=h.length;v<x;v++){var _=h[v].multiPoly;i.indexOf(_)===-1&&i.push(_)}return this._afterState}},{key:"isInResult",value:function(){if(this.consumedBy)return!1;if(this._isInResult!==void 0)return this._isInResult;var t=this.beforeState().multiPolys,e=this.afterState().multiPolys;switch(E.type){case"union":{var r=t.length===0,i=e.length===0;this._isInResult=r!==i;break}case"intersection":{var n,s;t.length<e.length?(n=t.length,s=e.length):(n=e.length,s=t.length),this._isInResult=s===E.numMultiPolys&&n<s;break}case"xor":{var a=Math.abs(t.length-e.length);this._isInResult=a%2===1;break}case"difference":{var l=function(u){return u.length===1&&u[0].isSubject};this._isInResult=l(t)!==l(e);break}default:throw new Error("Unrecognized operation type found ".concat(E.type))}return this._isInResult}}],[{key:"fromRing",value:function(t,e,r){var i,n,s,a=L.comparePoints(t,e);if(a<0)i=t,n=e,s=1;else if(a>0)i=e,n=t,s=-1;else throw new Error("Tried to create degenerate segment at [".concat(t.x,", ").concat(t.y,"]"));var l=new L(i,!0),u=new L(n,!1);return new o(l,u,[r],[s])}}]),o}(),St=function(){function o(t,e,r){if(S(this,o),!Array.isArray(t)||t.length===0)throw new Error("Input geometry is not a valid Polygon or MultiPolygon");if(this.poly=e,this.isExterior=r,this.segments=[],typeof t[0][0]!="number"||typeof t[0][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var i=Z.round(t[0][0],t[0][1]);this.bbox={ll:{x:i.x,y:i.y},ur:{x:i.x,y:i.y}};for(var n=i,s=1,a=t.length;s<a;s++){if(typeof t[s][0]!="number"||typeof t[s][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var l=Z.round(t[s][0],t[s][1]);l.x===n.x&&l.y===n.y||(this.segments.push(W.fromRing(n,l,this)),l.x<this.bbox.ll.x&&(this.bbox.ll.x=l.x),l.y<this.bbox.ll.y&&(this.bbox.ll.y=l.y),l.x>this.bbox.ur.x&&(this.bbox.ur.x=l.x),l.y>this.bbox.ur.y&&(this.bbox.ur.y=l.y),n=l)}(i.x!==n.x||i.y!==n.y)&&this.segments.push(W.fromRing(n,i,this))}return b(o,[{key:"getSweepEvents",value:function(){for(var t=[],e=0,r=this.segments.length;e<r;e++){var i=this.segments[e];t.push(i.leftSE),t.push(i.rightSE)}return t}}]),o}(),de=function(){function o(t,e){if(S(this,o),!Array.isArray(t))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");this.exteriorRing=new St(t[0],this,!0),this.bbox={ll:{x:this.exteriorRing.bbox.ll.x,y:this.exteriorRing.bbox.ll.y},ur:{x:this.exteriorRing.bbox.ur.x,y:this.exteriorRing.bbox.ur.y}},this.interiorRings=[];for(var r=1,i=t.length;r<i;r++){var n=new St(t[r],this,!1);n.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=n.bbox.ll.x),n.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=n.bbox.ll.y),n.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=n.bbox.ur.x),n.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=n.bbox.ur.y),this.interiorRings.push(n)}this.multiPoly=e}return b(o,[{key:"getSweepEvents",value:function(){for(var t=this.exteriorRing.getSweepEvents(),e=0,r=this.interiorRings.length;e<r;e++)for(var i=this.interiorRings[e].getSweepEvents(),n=0,s=i.length;n<s;n++)t.push(i[n]);return t}}]),o}(),wt=function(){function o(t,e){if(S(this,o),!Array.isArray(t))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");try{typeof t[0][0][0]=="number"&&(t=[t])}catch{}this.polys=[],this.bbox={ll:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY},ur:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY}};for(var r=0,i=t.length;r<i;r++){var n=new de(t[r],this);n.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=n.bbox.ll.x),n.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=n.bbox.ll.y),n.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=n.bbox.ur.x),n.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=n.bbox.ur.y),this.polys.push(n)}this.isSubject=e}return b(o,[{key:"getSweepEvents",value:function(){for(var t=[],e=0,r=this.polys.length;e<r;e++)for(var i=this.polys[e].getSweepEvents(),n=0,s=i.length;n<s;n++)t.push(i[n]);return t}}]),o}(),pe=function(){b(o,null,[{key:"factory",value:function(t){for(var e=[],r=0,i=t.length;r<i;r++){var n=t[r];if(!(!n.isInResult()||n.ringOut)){for(var s=null,a=n.leftSE,l=n.rightSE,u=[a],h=a.point,c=[];s=a,a=l,u.push(a),a.point!==h;)for(;;){var d=a.getAvailableLinkedEvents();if(d.length===0){var p=u[0].point,f=u[u.length-1].point;throw new Error("Unable to complete output ring starting at [".concat(p.x,",")+" ".concat(p.y,"]. Last matching segment found ends at")+" [".concat(f.x,", ").concat(f.y,"]."))}if(d.length===1){l=d[0].otherSE;break}for(var g=null,m=0,v=c.length;m<v;m++)if(c[m].point===a.point){g=m;break}if(g!==null){var x=c.splice(g)[0],_=u.splice(x.index);_.unshift(_[0].otherSE),e.push(new o(_.reverse()));continue}c.push({index:u.length,point:a.point});var k=a.getLeftmostComparator(s);l=d.sort(k)[0].otherSE;break}e.push(new o(u))}}return e}}]);function o(t){S(this,o),this.events=t;for(var e=0,r=t.length;e<r;e++)t[e].segment.ringOut=this;this.poly=null}return b(o,[{key:"getGeom",value:function(){for(var t=this.events[0].point,e=[t],r=1,i=this.events.length-1;r<i;r++){var n=this.events[r].point,s=this.events[r+1].point;vt(n,t,s)!==0&&(e.push(n),t=n)}if(e.length===1)return null;var a=e[0],l=e[1];vt(a,t,l)===0&&e.shift(),e.push(e[0]);for(var u=this.isExteriorRing()?1:-1,h=this.isExteriorRing()?0:e.length-1,c=this.isExteriorRing()?e.length:-1,d=[],p=h;p!=c;p+=u)d.push([e[p].x,e[p].y]);return d}},{key:"isExteriorRing",value:function(){if(this._isExteriorRing===void 0){var t=this.enclosingRing();this._isExteriorRing=t?!t.isExteriorRing():!0}return this._isExteriorRing}},{key:"enclosingRing",value:function(){return this._enclosingRing===void 0&&(this._enclosingRing=this._calcEnclosingRing()),this._enclosingRing}},{key:"_calcEnclosingRing",value:function(){for(var t=this.events[0],e=1,r=this.events.length;e<r;e++){var i=this.events[e];L.compare(t,i)>0&&(t=i)}for(var n=t.segment.prevInResult(),s=n?n.prevInResult():null;;){if(!n)return null;if(!s)return n.ringOut;if(s.ringOut!==n.ringOut)return s.ringOut.enclosingRing()!==n.ringOut?n.ringOut:n.ringOut.enclosingRing();n=s.prevInResult(),s=n?n.prevInResult():null}}}]),o}(),Et=function(){function o(t){S(this,o),this.exteriorRing=t,t.poly=this,this.interiorRings=[]}return b(o,[{key:"addInterior",value:function(t){this.interiorRings.push(t),t.poly=this}},{key:"getGeom",value:function(){var t=[this.exteriorRing.getGeom()];if(t[0]===null)return null;for(var e=0,r=this.interiorRings.length;e<r;e++){var i=this.interiorRings[e].getGeom();i!==null&&t.push(i)}return t}}]),o}(),fe=function(){function o(t){S(this,o),this.rings=t,this.polys=this._composePolys(t)}return b(o,[{key:"getGeom",value:function(){for(var t=[],e=0,r=this.polys.length;e<r;e++){var i=this.polys[e].getGeom();i!==null&&t.push(i)}return t}},{key:"_composePolys",value:function(t){for(var e=[],r=0,i=t.length;r<i;r++){var n=t[r];if(!n.poly)if(n.isExteriorRing())e.push(new Et(n));else{var s=n.enclosingRing();s.poly||e.push(new Et(s)),s.poly.addInterior(n)}}return e}}]),o}(),ge=function(){function o(t){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:W.compare;S(this,o),this.queue=t,this.tree=new ut(e),this.segments=[]}return b(o,[{key:"process",value:function(t){var e=t.segment,r=[];if(t.consumedBy)return t.isLeft?this.queue.remove(t.otherSE):this.tree.remove(e),r;var i=t.isLeft?this.tree.insert(e):this.tree.find(e);if(!i)throw new Error("Unable to find segment #".concat(e.id," ")+"[".concat(e.leftSE.point.x,", ").concat(e.leftSE.point.y,"] -> ")+"[".concat(e.rightSE.point.x,", ").concat(e.rightSE.point.y,"] ")+"in SweepLine tree. Please submit a bug report.");for(var n=i,s=i,a=void 0,l=void 0;a===void 0;)n=this.tree.prev(n),n===null?a=null:n.key.consumedBy===void 0&&(a=n.key);for(;l===void 0;)s=this.tree.next(s),s===null?l=null:s.key.consumedBy===void 0&&(l=s.key);if(t.isLeft){var u=null;if(a){var h=a.getIntersection(e);if(h!==null&&(e.isAnEndpoint(h)||(u=h),!a.isAnEndpoint(h)))for(var c=this._splitSafely(a,h),d=0,p=c.length;d<p;d++)r.push(c[d])}var f=null;if(l){var g=l.getIntersection(e);if(g!==null&&(e.isAnEndpoint(g)||(f=g),!l.isAnEndpoint(g)))for(var m=this._splitSafely(l,g),v=0,x=m.length;v<x;v++)r.push(m[v])}if(u!==null||f!==null){var _=null;if(u===null)_=f;else if(f===null)_=u;else{var k=L.comparePoints(u,f);_=k<=0?u:f}this.queue.remove(e.rightSE),r.push(e.rightSE);for(var D=e.split(_),M=0,N=D.length;M<N;M++)r.push(D[M])}r.length>0?(this.tree.remove(e),r.push(t)):(this.segments.push(e),e.prev=a)}else{if(a&&l){var w=a.getIntersection(l);if(w!==null){if(!a.isAnEndpoint(w))for(var O=this._splitSafely(a,w),F=0,U=O.length;F<U;F++)r.push(O[F]);if(!l.isAnEndpoint(w))for(var T=this._splitSafely(l,w),B=0,H=T.length;B<H;B++)r.push(T[B])}}this.tree.remove(e)}return r}},{key:"_splitSafely",value:function(t,e){this.tree.remove(t);var r=t.rightSE;this.queue.remove(r);var i=t.split(e);return i.push(r),t.consumedBy===void 0&&this.tree.insert(t),i}}]),o}(),kt=typeof process<"u"&&Bt.POLYGON_CLIPPING_MAX_QUEUE_SIZE||1e6,ye=typeof process<"u"&&Bt.POLYGON_CLIPPING_MAX_SWEEPLINE_SEGMENTS||1e6,_e=function(){function o(){S(this,o)}return b(o,[{key:"run",value:function(t,e,r){E.type=t,Z.reset();for(var i=[new wt(e,!0)],n=0,s=r.length;n<s;n++)i.push(new wt(r[n],!1));if(E.numMultiPolys=i.length,E.type==="difference")for(var a=i[0],l=1;l<i.length;)ot(i[l].bbox,a.bbox)!==null?l++:i.splice(l,1);if(E.type==="intersection"){for(var u=0,h=i.length;u<h;u++)for(var c=i[u],d=u+1,p=i.length;d<p;d++)if(ot(c.bbox,i[d].bbox)===null)return[]}for(var f=new ut(L.compare),g=0,m=i.length;g<m;g++)for(var v=i[g].getSweepEvents(),x=0,_=v.length;x<_;x++)if(f.insert(v[x]),f.size>kt)throw new Error("Infinite loop when putting segment endpoints in a priority queue (queue size too big). Please file a bug report.");for(var k=new ge(f),D=f.size,M=f.pop();M;){var N=M.key;if(f.size===D){var w=N.segment;throw new Error("Unable to pop() ".concat(N.isLeft?"left":"right"," SweepEvent ")+"[".concat(N.point.x,", ").concat(N.point.y,"] from segment #").concat(w.id," ")+"[".concat(w.leftSE.point.x,", ").concat(w.leftSE.point.y,"] -> ")+"[".concat(w.rightSE.point.x,", ").concat(w.rightSE.point.y,"] from queue. ")+"Please file a bug report.")}if(f.size>kt)throw new Error("Infinite loop when passing sweep line over endpoints (queue size too big). Please file a bug report.");if(k.segments.length>ye)throw new Error("Infinite loop when passing sweep line over endpoints (too many sweep line segments). Please file a bug report.");for(var O=k.process(N),F=0,U=O.length;F<U;F++){var T=O[F];T.consumedBy===void 0&&f.insert(T)}D=f.size,M=f.pop()}Z.reset();var B=pe.factory(k.segments),H=new fe(B);return H.getGeom()}}]),o}(),E=new _e,me=function(o){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return E.run("union",o,e)},ve=function(o){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return E.run("intersection",o,e)},be=function(o){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return E.run("xor",o,e)},xe=function(o){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return E.run("difference",o,e)},Se={union:me,intersection:ve,xor:be,difference:xe};function we(o,t,e){e===void 0&&(e={});var r=gt(o),i=gt(t),n=Se.intersection(r.coordinates,i.coordinates);return n.length===0?null:n.length===1?tt(n[0],e.properties):Kt(n,e.properties)}const y={mergeArray(o,t){if(t.length<5e4)o.push.apply(o,t);else for(let e=0,r=t.length;e<r;e+=1)o.push(t[e])},now:Date.now||function(){return new Date().getTime()},bind(o,t){return o.bind?o.bind(t):function(){return o.apply(t,arguments)}},forEach(o,t,e){if(o.forEach)return o.forEach(t,e);for(let r=0,i=o.length;r<i;r++)t.call(e,o[r],r)},map(o,t,e){if(o.map)return o.map(t,e);const r=[];for(let i=0,n=o.length;i<n;i++)r[i]=t.call(e,o[i],i);return r},merge(o,t){if(t.length<5e4)Array.prototype.push.apply(o,t);else for(let e=0,r=t.length;e<r;e+=1)o.push(t[e])},arrayIndexOf(o,t,e){if(o.indexOf)return o.indexOf(t,e);let r,i=o,n=i.length>>>0;if(n===0)return-1;const s=0|e;if(s>=n)return-1;for(r=Math.max(s>=0?s:n-Math.abs(s),0);r<n;){if(r in i&&i[r]===t)return r;r++}return-1},extend(o){return o||(o={}),this.extendObjs(o,Array.prototype.slice.call(arguments,1))},extendObjs(o,t){o||(o={});for(let e=0,r=t.length;e<r;e++){const i=t[e];if(i)for(const n in i)i.hasOwnProperty(n)&&(o[n]=i[n])}return o},debounce(o,t,e){let r,i,n,s,a,l=function(){const u=y.now()-s;u<t&&u>=0?r=setTimeout(l,t-u):(r=null,e||(a=o.apply(n,i),r||(n=i=null)))};return function(){n=this,i=arguments,s=y.now();const u=e&&!r;return r||(r=setTimeout(l,t)),u&&(a=o.apply(n,i),n=i=null),a}},throttle(o,t,e){let r,i,n,s=null,a=0;e||(e={});const l=function(){a=e.leading===!1?0:y.now(),s=null,n=o.apply(r,i),s||(r=i=null)};return function(){const u=y.now();a||e.leading!==!1||(a=u);const h=t-(u-a);return r=this,i=arguments,h<=0||h>t?(s&&(clearTimeout(s),s=null),a=u,n=o.apply(r,i),s||(r=i=null)):s||e.trailing===!1||(s=setTimeout(l,h)),n}},escapeHtml(o){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};return`${o}`.replace(/[&<>"']/g,function(e){return t[e]})}};var ht={BBRFLAG:{I:1,S:2},ADCODES:{COUNTRY:1e5}};function Ee(o){return o}function ke(o){if(o==null)return Ee;var t,e,r=o.scale[0],i=o.scale[1],n=o.translate[0],s=o.translate[1];return function(a,l){l||(t=e=0);var u=2,h=a.length,c=new Array(h);for(c[0]=(t+=a[0])*r+n,c[1]=(e+=a[1])*i+s;u<h;)c[u]=a[u],++u;return c}}function Le(o,t){for(var e,r=o.length,i=r-t;i<--r;)e=o[i],o[i++]=o[r],o[r]=e}function Ae(o,t){return typeof t=="string"&&(t=o.objects[t]),t.type==="GeometryCollection"?{type:"FeatureCollection",features:t.geometries.map(function(e){return Lt(o,e)})}:Lt(o,t)}function Lt(o,t){var e=t.id,r=t.bbox,i=t.properties==null?{}:t.properties,n=Ie(o,t);return e==null&&r==null?{type:"Feature",properties:i,geometry:n}:r==null?{type:"Feature",id:e,properties:i,geometry:n}:{type:"Feature",id:e,bbox:r,properties:i,geometry:n}}function Ie(o,t){var e=ke(o.transform),r=o.arcs;function i(h,c){c.length&&c.pop();for(var d=r[h<0?~h:h],p=0,f=d.length;p<f;++p)c.push(e(d[p],p));h<0&&Le(c,f)}function n(h){return e(h)}function s(h){for(var c=[],d=0,p=h.length;d<p;++d)i(h[d],c);return c.length<2&&c.push(c[0]),c}function a(h){for(var c=s(h);c.length<4;)c.push(c[0]);return c}function l(h){return h.map(a)}function u(h){var c=h.type,d;switch(c){case"GeometryCollection":return{type:c,geometries:h.geometries.map(u)};case"Point":d=n(h.coordinates);break;case"MultiPoint":d=h.coordinates.map(n);break;case"LineString":d=s(h.arcs);break;case"MultiLineString":d=h.arcs.map(s);break;case"Polygon":d=l(h.arcs);break;case"MultiPolygon":d=h.arcs.map(l);break;default:return null}return{type:c,coordinates:d}}return u(t)}function Pe(o,t){let e,r,i,n,s=o;e=t[t.length-2];for(let a=0,l=t.length-1;a<l;a++){r=t[a];const u=s;s=[],i=u[u.length-1];for(let h=0,c=u.length;h<c;h++)n=u[h],J(n,e,r)?(J(i,e,r)||s.push(At(e,r,i,n)),s.push(n)):J(i,e,r)&&s.push(At(e,r,i,n)),i=n;e=r}return s.length<3?[]:(s.push(s[0]),s)}function Me(o,t,e){const r=(e[1]-t[1])/(e[0]-t[0])*(o[0]-t[0])+t[1];return Math.abs(r-o[1])<1e-6&&o[0]>=t[0]&&o[0]<=e[0]}function Ne(o,t){for(let e=0,r=t.length;e<r-1;e++)if(Me(o,t[e],t[e+1]))return!0;return!1}function Fe(o,t){let e=!1;for(let r=o[0],i=o[1],n=0,s=t.length,a=s-1;n<s;a=n++){const l=t[n][0],u=t[n][1],h=t[a][0],c=t[a][1];u>i!=c>i&&r<(h-l)*(i-u)/(c-u)+l&&(e=!e)}return e}function Re(o,t,e){let r,i=t[0],n=t[1];const s=e[0]-i,a=e[1]-n,l=s*s+a*a;return l>0&&(r=((o[0]-i)*s+(o[1]-n)*a)/l,r>1?(i=e[0],n=e[1]):r>0&&(i+=s*r,n+=a*r)),[i,n]}function Ce(o,t,e){const r=Re(o,t,e),i=o[0]-r[0],n=o[1]-r[1];return i*i+n*n}function De(o,t){let e=Number.MAX_VALUE;for(let r=0,i=t.length;r<i-1;r++){const n=Ce(o,t[r],t[r+1]);n<e&&(e=n)}return e}function J(o,t,e){return(e[0]-t[0])*(o[1]-t[1])>(e[1]-t[1])*(o[0]-t[0])}function At(o,t,e,r){const i=[o[0]-t[0],o[1]-t[1]],n=[e[0]-r[0],e[1]-r[1]],s=o[0]*t[1]-o[1]*t[0],a=e[0]*r[1]-e[1]*r[0],l=1/(i[0]*n[1]-i[1]*n[0]);return[(s*n[0]-a*i[0])*l,(s*n[1]-a*i[1])*l]}var V={sqClosestDistanceToPolygon:De,pointOnPolygon:Ne,pointInPolygon:Fe,polygonClip:Pe};const ct=ht.BBRFLAG,Q=[];function Oe(o,t){const e=[];for(let r=0,i=o.length;r<i;r++){const n=o[r].split("-");let s=n[0],a=n.length>1?n[1]:s;s=parseInt(s,t),a=parseInt(a,t);for(let l=s;l<=a;l++)e.push(l)}return e}function Zt(o,t,e){if(o[t])throw new Error(`Alreay exists:  ${o[t]}`);o[t]=e}function Te(o){return Q[o]||(Q[o]=[ct.I,o]),Q[o]}function Be(o,t,e){if(o)for(let r=o.split(":"),i=parseInt(r[0],t),n=Oe(r[1].split(","),t),s=Te(i),a=0,l=n.length;a<l;a++)Zt(e,n[a],s)}function ze(o,t,e){if(o){const r=[];let i=o.split(":"),n=parseInt(i[0],t);const s=i[1].split(";");for(let a=0,l=s.length;a<l;a++){i=s[a].split(",");const u=[parseInt(i[0],t),0];i.length>1&&(u[1]=parseInt(i[1],t)),r.push(u)}Zt(e,n,[ct.S,r])}}function jt(o,t){if(!o)return null;const e=o.split(","),r=[];for(let i=0,n=e.length;i<n;i++){if(parseInt(e[i],t)<0)return null;r.push(parseInt(e[i],t))}return r}function Ge(o,t){if(!o)return null;const e=o.split(";"),r=[];for(let i=0,n=e.length;i<n;i++)r.push(jt(e[i],t));return r}function Ze(o){let t,e;const r=o.r,i=[],n=o.idx.i.split("|");for(o.idx.i=null,t=0,e=n.length;t<e;t++)Be(n[t],r,i);n.length=0;const s=o.idx.s.split("|");for(o.idx.s=null,t=0,e=s.length;t<e;t++)ze(s[t],r,i);s.length=0,o.idx=null,o.idxList=i,o.mxr&&(o.maxRect=jt(o.mxr,r),o.mxr=null),o.mxsr&&(o.maxSubRect=Ge(o.mxsr,r),o.mxsr=null)}function je(o,t,e){for(let r=o.geoData.sub.features,i=0,n=e.length;i<n;i++){const s=e[i],a=r[s[0]],l=a.geometry.coordinates[s[1]][0],u=V.polygonClip(l,t);!u||u.length<4?console.warn(`Cliped ring length werid: ${u}`):s[2]=u}return!0}function Ve(o,t,e){const r=o.bbIndex,i=r.s;(t<0||e<0||e>=r.h||t>=r.w)&&console.warn("Wrong x,y",t,e,r);const n=e*r.w+t,s=r.idxList[n];if(s[0]!==ct.S)return!1;const a=s[1];if(a[0].length>2)return!1;const l=t*i+r.l,u=e*i+r.t;return je(o,[[l,u],[l+i,u],[l+i,u+i],[l,u+i],[l,u]],a),!0}var Vt={prepareGridFeatureClip:Ve,buildIdxList:Ze};class C{constructor(t,e,r,i){this.x=t,this.y=e,this.width=r,this.height=i}static getBoundsItemToExpand(){return new C(Number.MAX_VALUE,Number.MAX_VALUE,-1,-1)}static boundsIntersect(t,e){return t.x<=e.x+e.width&&e.x<=t.x+t.width&&t.y<=e.y+e.height&&e.y<=t.y+t.height}isEmpty(){return this.width<0}expandByPoint(t,e){let r,i,n,s;this.isEmpty()?(r=n=t,i=s=e):(r=this.x,i=this.y,n=this.x+this.width,s=this.y+this.height,t<r?r=t:t>n&&(n=t),e<i?i=e:e>s&&(s=e)),this.x=r,this.y=i,this.width=n-r,this.height=s-i}}function $e(o){const t={},e=o.objects;for(const r in e)t[r]=Ae(o,e[r]);return t}function qe(o){for(let t=o.sub?o.sub.features:[],e=o.parent.properties,r=(e.acroutes||[]).concat([e.adcode]),i=0,n=t.length;i<n;i++)t[i].properties.subFeatureIndex=i,t[i].properties.acroutes=r}function We(o){if(!o._isBuiled){Vt.buildIdxList(o.bbIndex),o.geoData=$e(o.topo),o.geoData.sub&&qe(o.geoData);const t=o.topo.bbox;o.bounds=new C(t[0],t[1],t[2]-t[0],t[3]-t[1]),o.topo=null,o._isBuiled=!0}return o}var Ue={buildData:We};const K={},R=Math.PI/180,It=180/Math.PI,He=Math.PI/4,$t=.5/Math.PI;function dt(o){return K[o]||(K[o]=256*Math.pow(2,o)),K[o]}function Ye(o){let t=o[1],e=o[0]*R,r=t*R;return r=Math.log(Math.tan(He+r/2)),[e,r]}function Xe(o,t){t=t||1;const e=$t,r=.5,i=-e;return[t*(e*o[0]+r),t*(i*o[1]+.5)]}function Je(o){const t=o[0]*It,e=(2*Math.atan(Math.exp(o[1]))-Math.PI/2)*It;return[parseFloat(t.toFixed(6)),parseFloat(e.toFixed(6))]}function Qe(o,t){const e=$t,r=.5,i=-e;return[(o[0]/t-r)/e,(o[1]/t-.5)/i]}function qt(o,t,e){const r=Xe(Ye(o),t);return e&&(r[0]=Math.round(r[0]),r[1]=Math.round(r[1])),r}function Ke(o,t,e){return qt(o,dt(t),e)}function tr(o,t){const e=dt(t),r=Qe(o,e);return Je(r)}function er(o,t){const e=Math.cos,r=o[1]*R,i=o[0]*R,n=t[1]*R,s=t[0]*R,a=n-r,l=s-i,u=(1-e(a)+(1-e(l))*e(r)*e(n))/2;return 12756274*Math.asin(Math.sqrt(u))}var at={haversineDistance:er,getScale:dt,lngLatToPointByScale:qt,pointToLngLat:tr,lngLatToPoint:Ke};class pt{constructor(t,e,r){this.adcode=t,this._data=e,this._sqScaleFactor=e.scale*e.scale,this._opts=Object.assign({nearTolerance:2},r),this.setNearTolerance(this._opts.nearTolerance)}static getPropsOfFeature(t){return t&&t.properties?t.properties:null}static getAdcodeOfFeature(t){return t?t.properties.adcode:null}static doesFeatureHasChildren(t){return!!t&&t.properties.childrenNum>0}setNearTolerance(t){this._opts.nearTolerance=t,this._sqNearTolerance=t*t}getIdealZoom(){return this._data.idealZoom}_getEmptySubFeatureGroupItem(t){return{subFeatureIndex:t,subFeature:this.getSubFeatureByIndex(t),pointsIndexes:[],points:[]}}groupByPosition(t,e){let r,i,n={},s=null;for(r=0,i=t.length;r<i;r++){const l=this.getLocatedSubFeatureIndex(e.call(null,t[r],r));n[l]||(n[l]=this._getEmptySubFeatureGroupItem(l)),n[l].pointsIndexes.push(r),n[l].points.push(t[r]),l<0&&(s=n[l])}const a=[];if(this._data.geoData.sub)for(r=0,i=this._data.geoData.sub.features.length;r<i;r++)a.push(n[r]||this._getEmptySubFeatureGroupItem(r));return s&&a.push(s),n=null,a}getLocatedSubFeatureIndex(t){return this._getLocatedSubFeatureIndexByPixel(this.lngLatToPixel(t))}getSubFeatureByIndex(t){return t>=0?this.getSubFeatures()[t]:null}_getLocatedSubFeatureIndexByPixel(t){if(!this._data.geoData.sub)return-1;const e=this._data,r=e.bbIndex,i=t[0]-r.l,n=t[1]-r.t,s=Math.floor(n/r.s),a=Math.floor(i/r.s);if(a<0||s<0||s>=r.h||a>=r.w)return-1;const l=s*r.w+a,u=r.idxList[l];if(!u)return-1;const h=ht.BBRFLAG;switch(u[0]){case h.I:return u[1];case h.S:return Vt.prepareGridFeatureClip(e,a,s),this._calcLocatedFeatureIndexOfSList(t,u[1]);default:throw new Error(`Unknown BBRFLAG: ${u[0]}`)}}_calcNearestFeatureIndexOfSList(t,e){let r=[];this._data.geoData.sub&&(r=this._data.geoData.sub.features);const i={sq:Number.MAX_VALUE,idx:-1};for(let n=0,s=e.length;n<s;n++){const a=e[n],l=r[a[0]],u=a[2]||l.geometry.coordinates[a[1]][0],h=V.sqClosestDistanceToPolygon(t,u);h<i.sq&&(i.sq=h,i.idx=a[0])}return i.sq/this._sqScaleFactor<this._sqNearTolerance?i.idx:-1}_calcLocatedFeatureIndexOfSList(t,e){for(let r=this._data.geoData.sub.features,i=0,n=e.length;i<n;i++){const s=e[i],a=r[s[0]],l=s[2]||a.geometry.coordinates[s[1]][0];if(V.pointInPolygon(t,l)||V.pointOnPolygon(t,l))return s[0]}return this._calcNearestFeatureIndexOfSList(t,e)}pixelToLngLat(t,e){return at.pointToLngLat([t,e],this._data.pz)}lngLatToPixel(t){t instanceof AMap.LngLat&&(t=[t.getLng(),t.getLat()]);const e=at.lngLatToPoint(t,this._data.pz);return[Math.round(e[0]),Math.round(e[1])]}_convertRingCoordsToLngLats(t){const e=[];for(let r=0,i=t.length;r<i;r++)e[r]=this.pixelToLngLat(t[r][0],t[r][1]);return e}_convertPolygonCoordsToLngLats(t){const e=[];for(let r=0,i=t.length;r<i;r++)e[r]=this._convertRingCoordsToLngLats(t[r]);return e}_convertMultiPolygonCoordsToLngLats(t){const e=[];for(let r=0,i=t.length;r<i;r++)e[r]=this._convertPolygonCoordsToLngLats(t[r]);return e}_convertCoordsToLngLats(t,e){switch(t){case"MultiPolygon":return this._convertMultiPolygonCoordsToLngLats(e);default:throw new Error(`Unknown type ${t}`)}}_createLngLatFeature(t,e){const r=Object.assign({},t);return e&&Object.assign(r.properties,e),r.geometry=Object.assign({},r.geometry),r.geometry.coordinates=this._convertCoordsToLngLats(r.geometry.type,r.geometry.coordinates),r}getAdcode(){return this.getProps("adcode")}getName(){return this.getProps("name")}getChildrenNum(){return this.getProps("childrenNum")}getProps(t){const e=pt.getPropsOfFeature(this._data.geoData.parent);return e?t?e[t]:e:null}getParentFeature(){const t=this._data.geoData;return t.lngLatParent||(t.lngLatParent=this._createLngLatFeature(t.parent)),t.lngLatParent}getParentFeatureInPixel(){return this._data.geoData.parent}getSubFeatures(){const t=this._data.geoData;if(!t.sub)return[];if(!t.lngLatSubList){const e=[];for(let r=t.sub.features,i=0,n=r.length;i<n;i++)e[i]=this._createLngLatFeature(r[i]);t.lngLatSubList=e}return[].concat(t.lngLatSubList)}getSubFeaturesInPixel(){return this._data.geoData.sub?[].concat(this._data.geoData.sub.features):[]}getBounds(){const t=this._data;if(!t.lngLatBounds){const e=this._data.bounds;t.lngLatBounds=new AMap.Bounds(this.pixelToLngLat(e.x,e.y+e.height),this.pixelToLngLat(e.x+e.width,e.y))}return t.lngLatBounds}}class rr extends lt{constructor(t){super(),this._opts=Object.assign({distDataLoc:"//webapi.amap.com/ui/1.1/ui/geo/DistrictExplorer/assets/d_v2"},t),this._areaNodesForLocating=null,this._areaNodeCache={},this._opts.preload&&this.loadMultiAreaNodes(this._opts.preload)}setAreaNodesForLocating(t){t?Array.isArray(t)||(t=[t]):t=[],this._areaNodesForLocating=t||[]}_loadJson(t,e){const r=this;return fetch(t,{headers:{Accept:"application/json"}}).then(i=>i.json()).then(i=>{e&&e.call(r,null,i)}).catch(i=>{if(!e)throw i;e(i)})}_getAreaNodeDataFileName(t){return`an_${t}.json`}_getAreaNodeDataSrc(t){return`${this._opts.distDataLoc}/${this._getAreaNodeDataFileName(t)}`}loadAreaTree(t){this._loadJson(`${this._opts.distDataLoc}/area_tree.json`,t)}loadCountryNode(t){this.loadAreaNode(ht.ADCODES.COUNTRY,t)}loadMultiAreaNodes(t,e){let r=[],i=!1,n;function s(a){return function(l,u){i||(n--,l?(e&&e(l),i=!0):(r[a]=u,n===0&&e&&e(null,r)))}}if(t&&t.length){const a=t.length;for(let l=0;l<a;l++)this.loadAreaNode(t[l],e?s(l):null)}else e&&e(null,[])}loadAreaNode(t,e,r,i){if(r=r||this,this._areaNodeCache[t]){if(e){const n=this._areaNodeCache[t];i?e.call(r,null,n,!0):setTimeout(function(){e.call(r,null,n)},0)}}else this._loadJson(this._getAreaNodeDataSrc(t),(n,s)=>{n?e&&e.call(r,n):(this._buildAreaNode(t,s),e&&e.call(r,null,this._areaNodeCache[t]))})}getLocalAreaNode(t){return this._areaNodeCache[t]||null}_buildAreaNode(t,e){if(!this._areaNodeCache[t]){if(!e)throw new Error(`Empty distData: ${t}`);const r=new pt(t,Ue.buildData(e),this._opts);this._areaNodeCache[t]=r,this._areaNodesForLocating||(this._areaNodesForLocating=[r])}}clearAreaNodeCacheByAdcode(t){const e=this._areaNodeCache;return delete e[t],!0}destroy(){this._areaNodesForLocating=null,this._areaNodeCache=null,this._opts=null}}class ir{constructor(t){this.isDistReady=!1,this.nodeMap={},this.waitFnList=[],this.singleDistExplorer=new rr({}),this._opts=y.extend({topAdcodes:[1e5]},t),this._touchMap={},this.singleDistExplorer.loadAreaTree((e,r)=>{if(e)throw e;if(this.filterAreaTree(r),this.singleCountryNode=r,this.isDistReady=!0,this.waitFnList.length){for(let i=0,n=this.waitFnList.length;i<n;i++)this.waitFnList[i][0].call(this.waitFnList[i][1]);this.waitFnList.length=0}this.singleDistExplorer.loadMultiAreaNodes(this._opts.topAdcodes)})}pixelToLngLat(t,e,r){return at.pointToLngLat([t,e],r)}getBounds(t){const e=t.bbounds;return new AMap.Bounds(this.pixelToLngLat(e.x,e.y+e.height,20),this.pixelToLngLat(e.x+e.width,e.y,20))}filterAreaTree(t){const e=[t];do{const r=e.pop();this.nodeMap[r.adcode]=r;const i=r.bbox;if(r.bbounds=new C(i[0],i[1],i[2],i[3]),r.bbox=this.getBounds(r),r.children)for(let n=r.children,s=0,a=n.length;s<a;s++)n[s].childIdx=s,e.push(n[s])}while(e.length)}isReady(){return this.isDistReady}getParentAdcode(t,e){if(!e){const r=this.getNodeByAdcode(t);if(!r)return console.warn(`Can not find node: ${t}`),null;e=r.acroutes}return e&&e.length?e[e.length-1]:null}getSubIdx(t){return this.getNodeByAdcode(t).childIdx}getChildrenNum(t){const e=this.getNodeByAdcode(t);return this.getChildrenNumOfNode(e)}getChildrenNumOfNode(t){return t.children?t.children.length:t.childrenNum||0}getNodeByAdcode(t){const e=this.nodeMap[t];if(!e){let r=this.singleDistExplorer.getLocalAreaNode(`${`${t}`.substr(0,4)}00`);if(r||(r=this.singleDistExplorer.getLocalAreaNode(`${`${t}`.substr(0,2)}0000`)),!r)return null;for(let i=r.getSubFeatures(),n=0,s=i.length;n<s;n++)if(i[n].properties.adcode===t)return i[n].properties}return e}getNodeChildren(t){const e=this.getNodeByAdcode(t);if(!e)return null;if(e.children)return e.children;if(e.childrenNum>=0){const r=this.singleDistExplorer.getLocalAreaNode(t);if(!r)return null;const i=[],n=r.getSubFeaturesInPixel();for(let s=0,a=n.length;s<a;s++)i.push(n[s].properties);return i}return null}getExplorer(){return this.singleDistExplorer}traverseCountry(t,e,r,i,n){this.traverseNode(this.singleCountryNode,t,e,r,i,n,[])}getNodeBoundsSize(t,e){const r=this.getPixelZoom(),i=Math.pow(2,r-e);return[t.bbounds.width/i,t.bbounds.height/i]}doesRingRingIntersect(t,e){const r=[t.getNorthWest().toArray(),t.getNorthEast().toArray(),t.getSouthEast().toArray(),t.getSouthWest().toArray(),t.getNorthWest().toArray()],i=[e.getNorthWest().toArray(),e.getNorthEast().toArray(),e.getSouthEast().toArray(),e.getSouthWest().toArray(),e.getNorthWest().toArray()];return!!we(tt([r]),tt([i]))}traverseNode(t,e,r,i,n,s,a,l){if(!(a&&a.indexOf(t.adcode)>=0)){if(this.doesRingRingIntersect(e,t.bbox)){const u=t.children,h=u&&u.length>0;if(r>t.idealZoom&&h)for(let c=0,d=u.length;c<d;c++)this.traverseNode(u[c],e,r,i,null,s,a);else i.call(s,t)}n&&(l?(l.count++,l.count>=l.total&&n.call(s)):n.call(s))}}onReady(t,e,r){this.isDistReady?r?t.call(e):setTimeout(function(){t.call(e)},0):this.waitFnList.push([t,e])}getPixelZoom(){var t;return(t=this.singleCountryNode)===null||t===void 0?void 0:t.pz}loadAreaNode(t,e,r,i){this.singleDistExplorer.loadAreaNode(t,e,r,i)}isExcludedAdcode(t){const e=this._opts.excludedAdcodes;return e&&e.indexOf(t)>=0}traverseTopNodes(t,e,r,i,n){const s=this._opts.topAdcodes,a=this._opts.excludedAdcodes,l={total:s.length,count:0};for(let u=0,h=s.length;u<h;u++){const c=this.getNodeByAdcode(s[u]);if(!c)throw new Error(`Can not find adcode: ${s[u]}`);this.traverseNode(c,t,e,r,i,n,a,l)}}tryClearCache(t,e){if(!(e<0)){const r=[this.singleCountryNode],i=[],n=this._touchMap;do{const a=r.pop();a.children&&y.mergeArray(r,a.children);const l=n[a.adcode];l&&l!==t&&i.push(a.adcode)}while(r.length);i.sort(function(a,l){const u=n[a]-n[l];return u===0?a-l:u});const s=i.length-e;if(!(s<=0))for(let a=0;a<s;a++)this.singleDistExplorer.clearAreaNodeCacheByAdcode(i[a])&&this.touchAdcode(i[a],null)}}touchAdcode(t,e){this._touchMap[t]=e}destroy(){this.singleDistExplorer.destroy(),this._touchMap={},this.nodeMap={},this.singleDistExplorer=void 0,this._opts=void 0,this.waitFnList=[],this.singleCountryNode=void 0}}function nr(o){return[o.x,o.y]}class or{constructor(t){this._data=[],this._pointsMap={},this._opts=y.extend({topAdcode:1e5},t),this.clearData()}clearData(){this._data=[],this._pointsMap={}}setData(t){this.clearData(),this._data=t,this._updatePointsMap(this._opts.topAdcode,"all",t)}_updatePointsMap(t,e,r){let i=this._pointsMap[t];i||(i=this._pointsMap[t]={}),i[e]=r,i[`${e}_pack`]=this._buildPackItemsByAdcode(t,r)}getPointsByAdcode(t,e){return this._pointsMap[t]?this._pointsMap[t][e||"all"]:[]}getPackItemsByAdcode(t,e){return this._pointsMap[t]?this._pointsMap[t][`${e||"all"}_pack`]:[]}_buildPackItemsByAdcode(t,e){const r=this._opts.pointPacker,i=[];for(let n=0,s=e.length;n<s;n++)i[n]=r.call(this._opts.pointPackerThisArg,e[n]);return i}calcDistGroup(t,e,r,i){const n=this._opts.distMgr.getNodeByAdcode(t);let s=n.acroutes||[1e5];e&&n.acroutes&&(s=[].concat(s),s.push(t)),this._calcGroupWithRoutes(s,0,r,i)}_calcGroupWithRoutes(t,e,r,i){const n=()=>{e<t.length-1?this._calcGroupWithRoutes(t,e+1,r,i):r&&r.call(i)},s=t[e];if(this.getPointsByAdcode(s,"__done"))n.call(this);else{const a=this.getPointsByAdcode(s);if(!a)throw new Error(`Not points found:  ${s}`);this._opts.distMgr.getExplorer().loadAreaNode(s,(l,u)=>{this._groupByAreaNode(u,a),n.call(this)},this,!0)}}_groupByAreaNode(t,e){const r=t.groupByPosition(e,nr),i=t.getAdcode()===this._opts.topAdcode,n=[];for(let s=0,a=r.length;s<a;s++){const l=r[s];l.subFeature?(this._updatePointsMap(l.subFeature.properties.adcode,"all",l.points),i&&y.mergeArray(n,l.points)):this._updatePointsMap(t.getAdcode(),"hanging",l.points)}i&&this._updatePointsMap(t.getAdcode(),"all",n),this._updatePointsMap(t.getAdcode(),"__done",!0)}destroy(){this.clearData(),this._opts=null}}var sr=Object.defineProperty,ar=Object.defineProperties,lr=Object.getOwnPropertyDescriptors,Pt=Object.getOwnPropertySymbols,ur=Object.prototype.hasOwnProperty,hr=Object.prototype.propertyIsEnumerable,Mt=(o,t,e)=>t in o?sr(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,Nt=(o,t)=>{for(var e in t||(t={}))ur.call(t,e)&&Mt(o,e,t[e]);if(Pt)for(var e of Pt(t))hr.call(t,e)&&Mt(o,e,t[e]);return o},cr=(o,t)=>ar(o,lr(t));class dr extends lt{constructor(t,e){super(),this.baseId=1,this._currentZoom=2,this._currentFeatures=[],this._loadLeft=0,this._polygonCache=[],this._markerCache=[],this._opts=y.extend({engine:"default",areaNodeCacheLimit:-1,minHeightToShowSubFeatures:630,minSiblingAvgHeightToShowSubFeatures:600,minSubAvgHeightToShowSubFeatures:300,zooms:[2,30],clusterMarkerEventSupport:!0,clusterMarkerClickToShowSub:!0,featureEventSupport:!0,featureClickToShowSub:!1,featureStyleByLevel:{country:{strokeColor:"rgb(31, 119, 180)",strokeOpacity:.9,strokeWeight:2,fillColor:"rgb(49, 163, 84)",fillOpacity:.8},province:{strokeColor:"rgb(31, 119, 180)",strokeOpacity:.9,strokeWeight:2,fillColor:"rgb(116, 196, 118)",fillOpacity:.7},city:{strokeColor:"rgb(31, 119, 180)",strokeOpacity:.9,strokeWeight:2,fillColor:"rgb(161, 217, 155)",fillOpacity:.6},district:{strokeColor:"rgb(31, 119, 180)",strokeOpacity:.9,strokeWeight:2,fillColor:"rgb(199, 233, 192)",fillOpacity:.5}}},e),this._map=this._opts.map,this._createLayer(),this._ins=t,this._isRendering=!1,this._loadLeft=0,this._currentFeatures=[]}_createLayer(){this.markerGroup=new AMap.OverlayGroup,this._map.add(this.markerGroup),this.layer=new AMap.VectorLayer({zIndex:this._opts.zIndex||10,visible:this._opts.visible||!0}),this._map.addLayer(this.layer)}zoomToShowSubFeatures(t,e){const r=this.getMinZoomToShowSub(t);if(r>=3){const i=this._ins.getMap();i&&(e||(e=this._ins._distMgr.getNodeByAdcode(t).center),i.setZoomAndCenter(r,e))}}getPixelRatio(){return Math.min(2,Math.round(window.devicePixelRatio||1))}refreshViewState(){if(!this._ins._distMgr.isReady())return!1;const t=this._ins;if(!t.isReady())return!1;const e=t.getMap(),r=e.getBounds(),i=e.getSize(),n=e.getZoom(3),s=this._opts.zooms[1],a=Math.pow(2,s-n),l=r.getNorthWest(),u=e.lngLatToCoords([l.getLng(),l.getLat()]),h=new C(u[0],u[1],i.width*a,i.height*a);this._currentZoom=n,this._currentScaleFactor=a,this._currentViewBounds=h,this._currentViewBoundsInLngLat=r,this._currentPixelRatio=this.getPixelRatio()}renderViewport(){if(this.refreshViewState(),!this._currentViewBounds)return!1;this._currentRenderId=this.baseId++,this._loadLeft=0,this._currentFeatures=[],this._renderViewDist(this._currentRenderId),this._isRendering=!1}getCurrentRenderId(){return this._currentRenderId}isRenderIdStillValid(t){return t===this._currentRenderId}_renderViewDist(t){const e=[];if(this._currentZoom<this._opts.zooms[0]||this._currentZoom>this._opts.zooms[1]){this.isRenderIdStillValid(t)&&this._prepareFeatures(t,e);return}this._ins.getDistMgr().traverseTopNodes(this._currentViewBoundsInLngLat,this._currentZoom,r=>{e.push(r.adcode)},()=>{this.isRenderIdStillValid(t)&&this._prepareFeatures(t,e)},this)}getMinZoomToShowSub(t){const e=this._ins._distMgr.getNodeByAdcode(t);if(!e||!e.idealZoom)return-1;if(!e._minZoomToShowSub){const r=this._ins.getZooms();for(let i=r[0];i<=r[1];i++)if(this.shouldShowSubOnZoom(e,i)){e._minZoomToShowSub=i;break}}return e._minZoomToShowSub||-1}shouldShowSubOnZoom(t,e){if(!t.idealZoom)return!1;if(t._minZoomToShowSub&&e>=t._minZoomToShowSub)return!0;let r=this._ins._distMgr.getNodeBoundsSize(t,e);if(t.adcode===1e5&&r[1]>400)return!0;if(r[1]<this._opts.minHeightToShowSubFeatures)return!1;let i,n,s;if(t.children){const l=t.children;if(s=0,n=l.length,n){for(i=0;i<n;i++)r=this._ins._distMgr.getNodeBoundsSize(l[i],e),s+=r[1];if(s/n<this._opts.minSubAvgHeightToShowSubFeatures)return!1}}const a=this._ins._distMgr.getParentAdcode(t.adcode,t.acroutes);if(a){const l=this._ins._distMgr.getNodeByAdcode(a),u=l.children;if(u||console.error("No children bound",t,l),n=u.length,n>1){for(s=0,i=0;i<n;i++)u[i].adcode!==t.adcode&&(r=this._ins._distMgr.getNodeBoundsSize(u[i],e),s+=r[1]);if(s/(n-1)<this._opts.minSiblingAvgHeightToShowSubFeatures)return!1}}return!0}_shouldShowSub(t){return!(!t.children||!t.children.length)&&this.shouldShowSubOnZoom(t,this._currentZoom)}_prepareFeatures(t,e){const r=[],i=[];for(let n=0,s=e.length;n<s;n++){const a=this._ins._distMgr.getNodeByAdcode(e[n]);if(!a)throw new Error(`Can not find node: ${e[n]}`);this._shouldShowSub(a)?i.push(e[n]):r.push(e[n])}this._prepareSelfFeatures(t,r),this._prepareSubFeatures(t,i),this._checkLoadFinish(t)}_prepareSelfFeatures(t,e){let r;const i=this._currentZoom;for(let n=0,s=e.length;n<s;n++){const a=this._ins._distMgr.getNodeByAdcode(e[n]);if(r=null,a.acroutes){const l=this._ins._distMgr.getNodeByAdcode(a.acroutes[a.acroutes.length-1]);(!a.idealZoom||i<a.idealZoom-1||Math.abs(i-l.idealZoom)<=Math.abs(a.idealZoom-i))&&(r=l.adcode)}this._loadAndRenderSelf(t,r||e[n],e[n])}}_prepareSubFeatures(t,e){let r,i;for(r=0,i=e.length;r<i;r++)this._loadAndRenderSub(t,e[r])}_renderSelf(t,e,r){let i;if(e===r.getAdcode())i=r.getParentFeature();else{const n=r.getSubFeatures(),s=this._ins._distMgr.getSubIdx(e);if(i=n[s],!i){console.warn("Werid, can not find sub feature",r.getAdcode(),e);return}if(i.properties.adcode!==e){console.warn("Sub adcode not match!!",n,s);return}}this._ins.getDistCounter().calcDistGroup(e,!1,()=>{this.isRenderIdStillValid(t)&&this._prepRenderFeatureInPixel(t,i)},this)}_checkLoadFinish(t){if(this._loadLeft===0){const e=this;setTimeout(function(){e.isRenderIdStillValid(t)&&e._handleRenderFinish()},0)}}_renderSub(t,e){const r=e.getSubFeatures();this._ins.getDistCounter().calcDistGroup(e.getAdcode(),!0,()=>{if(this.isRenderIdStillValid(t))for(let i=0,n=r.length;i<n;i++)this._prepRenderFeatureInPixel(t,r[i])},this)}_handleRenderFinish(){this._tryFreeMemery(),this._renderAllFeature()}_renderAllFeature(){this._renderAllFeatureByDefault()}_renderAllFeatureByDefault(){var t,e;const r=[],i=[],n=[],s=[];for(let a=0;a<this._polygonCache.length;a++){const l=this._polygonCache[a],u=l.getExtData()._data.adcode;let h=!1;for(let c=0;c<this._currentFeatures.length;c++){const d=this._currentFeatures[c].feature.properties;if(u===d.adcode){h=!0,this._currentFeatures.splice(c,1);break}}h||(i.push(l),this._polygonCache.splice(a,1),s.push(this._markerCache[a]),this._markerCache.splice(a,1),a--)}this._currentFeatures.forEach(a=>{const l=this._createPolygonFeature(a.feature,a.dataItems);this._opts.featureEventSupport&&(l.on("click",y.bind(h=>{this.emit("featureClick",h,a.feature),this._opts.featureClickToShowSub&&this._ins.zoomToShowSubFeatures(a.feature.properties.adcode)},this)),l.on("mouseover",y.bind(h=>{this.emit("featureMouseover",h,a.feature)},this)),l.on("mouseout",y.bind(h=>{this.emit("featureMouseout",h,a.feature)},this)));const u=this._createClusterMarker(a.feature,a.dataItems);this._opts.clusterMarkerEventSupport&&u.on("click",y.bind(h=>{this.emit("clusterMarkerClick",h,Nt({adcode:a.feature.properties.adcode},a)),this._opts.clusterMarkerClickToShowSub&&this._ins.zoomToShowSubFeatures(a.feature.properties.adcode)},this)),r.push(l),n.push(u)}),this.layer.remove(i),(t=this.markerGroup)===null||t===void 0||t.removeOverlays(s),this.layer.add(r),this._polygonCache.push(...r),r.length=0,(e=this.markerGroup)===null||e===void 0||e.addOverlays(n),this._markerCache.push(...n),n.length=0}_tryFreeMemery(){this._ins.getDistMgr().tryClearCache(this._currentRenderId,this._opts.areaNodeCacheLimit)}_increaseLoadLeft(){this._loadLeft++}_decreaseLoadLeft(t){this._loadLeft--,this._loadLeft===0&&this._checkLoadFinish(t)}_loadAndRenderSelf(t,e,r){this._ins.getDistMgr().touchAdcode(e,t);const i=this._ins._distMgr.getExplorer(),n=i.getLocalAreaNode(e);n?this._renderSelf(t,r,n):(this._increaseLoadLeft(),i.loadAreaNode(e,(s,a)=>{this.isRenderIdStillValid(t)&&(s?console.error(s):this._renderSelf(t,r,a),this._decreaseLoadLeft(t))},this))}_loadAndRenderSub(t,e){this._ins.getDistMgr().touchAdcode(e,t);const r=this._ins._distMgr.getExplorer(),i=r.getLocalAreaNode(e);i?this._renderSub(t,i):(this._increaseLoadLeft(),r.loadAreaNode(e,(n,s)=>{this.isRenderIdStillValid(t)&&(n?console.error(n):this._renderSub(t,s),this._decreaseLoadLeft(t))},this))}_prepRenderFeatureInPixel(t,e){if(!this._ins.getDistMgr().isExcludedAdcode(e.properties.adcode)){const r=this._ins.getDistCounter().getPackItemsByAdcode(e.properties.adcode);this._currentFeatures.push({feature:e,dataItems:r})}}_createPolygonFeature(t,e){const r=Object.assign({},t.properties);if(r.dataItems=e,this._opts.renderPolygon){const n=this._opts.renderPolygon(t,e),s=n.getExtData()||{};return s._data=r,n.setExtData(s),n}const i=this._getFeatureStyleOptions(t,e)||{};return new AMap.Polygon(cr(Nt({path:t.geometry.coordinates},i),{extData:{_data:r}}))}_createClusterMarker(t,e){const r=t.properties;if(r.dataItems=e,this._opts.renderClusterMarker){const h=this._opts.renderClusterMarker(t,e),c=h.getExtData()||{};return c._data=r,h.setExtData(c),h}const i={title:"amap-ui-district-cluster-marker-title",body:"amap-ui-district-cluster-marker-body",container:"amap-ui-district-cluster-marker"},n=document.createElement("div"),s=document.createElement("span");s.className=i.title;const a=document.createElement("span");a.className=i.body,n.appendChild(s),n.appendChild(a);const l=[],u=[i.container,`level_${r.level}`,`adcode_${r.adcode}`];if(r.acroutes)for(let h=r.acroutes,c=0,d=h.length;c<d;c++)u.push(`descendant_of_${h[c]}`),c===d-1&&u.push(`child_of_${h[c]}`),c>0&&l.push(this._ins._distMgr.getNodeByAdcode(h[c]).name);return n.className=u.join(" "),l.length>0?(l.push(r.name),n.setAttribute("title",l.join(">"))):n.removeAttribute("title"),s.innerHTML=y.escapeHtml(r.name),a.innerHTML=e.length,new AMap.Marker({topWhenClick:!0,offset:new AMap.Pixel(-20,-30),content:n,position:r.center,extData:{_data:r}})}_getFeatureStyleOptions(t,e){const r=this._opts.getFeatureStyle,i=this._opts.featureStyleByLevel[t.properties.level];if(!r)return i;const n=r.call(null,t,e);return n?y.extend({},this._opts.featureStyleByLevel[t.properties.level],n):i}renderLater(t){this._renderLaterId||(this._renderLaterId=setTimeout(()=>{this.render()},t||100))}isRendering(){return this._isRendering}render(){this._renderLaterId&&(clearTimeout(this._renderLaterId),this._renderLaterId=null),this._isRendering=!0,this._ins._distMgr.onReady(this.renderViewport,this,!0)}forceRender(){this._renderLaterId&&(clearTimeout(this._renderLaterId),this._renderLaterId=null),this._isRendering=!0,this.clear(),this._ins._distMgr.onReady(this.renderViewport,this,!0)}getOption(t){return this._opts[t]}getOptions(){return this._opts}show(){var t;this.layer.show(),(t=this.markerGroup)===null||t===void 0||t.show()}hide(){var t;this.layer.hide(),(t=this.markerGroup)===null||t===void 0||t.hide()}clear(){var t;this.layer.clear(),(t=this.markerGroup)===null||t===void 0||t.clearOverlays(),this._polygonCache=[],this._markerCache=[]}setzIndex(t){this.layer.setzIndex(t)}getZooms(){return this._opts.zooms}destroy(){this._map.removeLayer(this.layer),this._map.remove(this.markerGroup),this._currentFeatures=[],this.clear(),this.layer=null,this._map=null,this._ins=null}}class pr{constructor(t,e,r){this.x=t,this.y=e,this.idx=r}}var fr=Object.defineProperty,gr=Object.defineProperties,yr=Object.getOwnPropertyDescriptors,Ft=Object.getOwnPropertySymbols,_r=Object.prototype.hasOwnProperty,mr=Object.prototype.propertyIsEnumerable,Rt=(o,t,e)=>t in o?fr(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,vr=(o,t)=>{for(var e in t||(t={}))_r.call(t,e)&&Rt(o,e,t[e]);if(Ft)for(var e of Ft(t))mr.call(t,e)&&Rt(o,e,t[e]);return o},br=(o,t)=>gr(o,yr(t));class xr extends lt{constructor(t){super(),this._data={list:[],bounds:null,source:null},this._mouseEvent=y.bind(y.debounce(()=>{this.renderLater()},50),this),this.initCSS();const e={autoSetFitView:!0,topAdcodes:[1e5],visible:!0,excludedAdcodes:null,zIndex:10,renderOptions:{}};this._opts=y.extend({},e,t),this.map=t.map,this._distMgr=new ir({topAdcodes:this._opts.topAdcodes,excludedAdcodes:this._opts.excludedAdcodes}),this._distCounter=new or({distMgr:this._distMgr,pointPackerThisArg:this,pointPacker:r=>this._packDataItem(r)}),this.renderEngine=new dr(this,br(vr({},t.renderOptions),{zIndex:this._opts.zIndex,visible:this._opts.visible,map:t.map})),this.renderEngine.on("*",(r,...i)=>{this.emit(r,...i)}),this._opts.data&&this.setData(this._opts.data),this.bindOrUnbindMapEvent()}bindOrUnbindMapEvent(t=!0){const e=t?"on":"off";this.map[e]("moveend",this._mouseEvent),this.map[e]("zoomend",this._mouseEvent),this.map[e]("resize",this._mouseEvent),this.map[e]("rotateend",this._mouseEvent),this.map[e]("dragend",this._mouseEvent)}initCSS(){const t="_amap_district_cluster_css";if(document.getElementById(t))return;const e=".amap-ui-district-cluster-container{cursor:default;-webkit-backface-visibility:hidden;-webkit-transform:translateZ(0) scale(1,1)}.amap-ui-district-cluster-container canvas{position:absolute}.amap-ui-district-cluster-container .amap-ui-hide{display:none!important}.amap-ui-district-cluster-container .overlay-title,.amap-ui-district-cluster-marker{color:#555;background-color:#fffeef;font-size:12px;white-space:nowrap;position:absolute}.amap-ui-district-cluster-container .overlay-title{padding:2px 6px;display:inline-block;z-index:99999;border:1px solid #7e7e7e;border-radius:2px}.amap-ui-district-cluster-container .overlay-title:after,.amap-ui-district-cluster-container .overlay-title:before{content:'';display:block;position:absolute;margin:auto;width:0;height:0;border:solid transparent;border-width:5px}.amap-ui-district-cluster-container .overlay-title.left{transform:translate(10px,-50%)}.amap-ui-district-cluster-container .overlay-title.left:before{top:5px}.amap-ui-district-cluster-container .overlay-title.left:after{left:-9px;top:5px;border-right-color:#fffeef}.amap-ui-district-cluster-container .overlay-title.left:before{left:-10px;border-right-color:#7e7e7e}.amap-ui-district-cluster-container .overlay-title.top{transform:translate(-50%,-130%)}.amap-ui-district-cluster-container .overlay-title.top:before{left:0;right:0}.amap-ui-district-cluster-container .overlay-title.top:after{bottom:-9px;left:0;right:0;border-top-color:#fffeef}.amap-ui-district-cluster-container .overlay-title.top:before{bottom:-10px;border-top-color:#7e7e7e}.amap-ui-district-cluster-marker{border:1px solid #8e8e8e;width:auto;height:22px;border-radius:5px 5px 5px 0;left:0;top:0}.amap-ui-district-cluster-marker:after,.amap-ui-district-cluster-marker:before{content:'';display:block;position:absolute;width:0;height:0;border:solid rgba(0,0,0,0);border-width:6px;left:13px}.amap-ui-district-cluster-marker:after{bottom:-12px;border-top-color:#fffeef}.amap-ui-district-cluster-marker:before{bottom:-13px;border-top-color:#8e8e8e}.amap-ui-district-cluster-marker span{vertical-align:middle;padding:3px 5px;display:inline-block;height:16px;line-height:16px}.amap-ui-district-cluster-marker-title{border-radius:5px 0 0 0}.amap-ui-district-cluster-marker-body{background-color:#dc3912;color:#fff;border-radius:0 5px 5px 0}.amap-ui-district-cluster-marker.level_country .amap-ui-district-cluster-marker-body{background-color:#36c}.amap-ui-district-cluster-marker.level_province .amap-ui-district-cluster-marker-body{background-color:#dc3912}.amap-ui-district-cluster-marker.level_city .amap-ui-district-cluster-marker-body{background-color:#909}.amap-ui-district-cluster-marker.level_district .amap-ui-district-cluster-marker-body{background-color:#d47}",r=document,i="appendChild",n="styleSheet",s=r.createElement("style");s.id=t,s.type="text/css",r.getElementsByTagName("head")[0][i](s),s[n]?s[n].cssText=e:s[i](r.createTextNode(e))}getMinZoomToShowSub(t){return this.renderEngine.getMinZoomToShowSub(t)}getAreaNodeProps(t){return this._distMgr.getNodeByAdcode(t)}getDistrictExplorer(){return this._distMgr.getExplorer()}getRender(){return this.renderEngine}zoomToShowSubFeatures(t,e){this.renderEngine.zoomToShowSubFeatures(t,e)}renderLater(t){this.renderEngine.renderLater(t)}render(){this.renderEngine.render()}forceRender(){this.renderEngine.forceRender()}getDistMgr(){return this._distMgr}_clearData(){this.trigger("willClearData"),this._data?this._data.list.length=0:this._data={list:[],bounds:null},this._data.source=null,this._data.bounds=null,this._data.kdTree=null,this._distCounter.clearData(),this.trigger("didClearData")}_buildDataItems(t){const e=this._opts,r=e.getPosition,i=this._data.list,n=this._data.bounds;for(let s=0,a=t.length;s<a;s++){let l=t[s],u=r.call(this,l,s);u&&(u.getLng&&(u=[u.getLng(),u.getLat()]),i[s]=new pr(u[0],u[1],s),n.expandByPoint(u[0],u[1]))}}getDataItemsByBounds(t){const e=this._data.kdTree;if(!e)return null;const r=t.getSouthWest(),i=t.getNorthEast(),n=this._data.list,s=e.range(r.getLng(),r.getLat(),i.getLng(),i.getLat()),a=[];for(let l=0,u=s.length;l<u;l++)a[l]=this._packDataItem(n[s[l]]);return a}_packDataItem(t){if(!t)return null;if(!t._packedItem){const e=t.idx,r=[t.x,t.y];t._packedItem={dataIndex:e,dataItem:this._data.source[e],position:r}}return t._packedItem}_buildData(t){this._clearData(),this.trigger("willBuildData",t),this._data.source=t,this._data.bounds=C.getBoundsItemToExpand(),this._buildDataItems(t),this._distCounter.setData(this._data.list),this.trigger("didBuildData",t)}setData(t){t||(t=[]),this._buildData(t),this.renderLater(10),t.length&&this._opts.autoSetFitView&&this.setFitView()}isReady(){return this._distMgr.isReady()&&!!this._data}setFitView(){const t=this._data.bounds,e=this.getMap(),r=new AMap.Bounds([t.x,t.y],[t.x+t.width,t.y+t.height]);e&&e.setBounds(r)}getDistCounter(){return this._distCounter}getMap(){return this._opts.map}getZooms(){return this.renderEngine.getZooms()}isHidden(){return!this._opts.visible}show(){return this._opts.visible=!0,this.getRender().show()}hide(){return this._opts.visible=!1,this.getRender().hide()}destroy(){this.bindOrUnbindMapEvent(!1),this.getRender().destroy(),this._distCounter.destroy(),this._distMgr.destroy(),this.renderEngine=null,this._data={list:[],bounds:null},this._distMgr=null,this.map=void 0,this._opts=void 0}getzIndex(){return this._opts.zIndex}setzIndex(t){this._opts.zIndex=t,this.getRender().setzIndex(t)}}const Sr=Ct({name:"ElAmapLayerDistrictCluster",inheritAttrs:!1,__name:"DistrictCluster",props:Wt({data:{required:!0,type:Array},getPosition:{type:Function},autoSetFitView:{type:Boolean,default:!0},topAdcodes:{type:Array},excludedAdcodes:{type:Array},renderOptions:{type:Object}}),emits:["init"],setup(o,{expose:t,emit:e}){const r=e;let i;const{$$getInstance:n}=Ut((a,l)=>new Promise(u=>{a.map=l,i=new xr(a),u(i)}),{emits:r,destroyComponent(){i&&(i.destroy(),i=null)}});t({$$getInstance:n});const s={emits:r,get $amapComponent(){return i},set $amapComponent(a){i=a},$$getInstance:n};return Object.defineProperty(s,"__isScriptSetup",{enumerable:!1,value:!0}),s}});function wr(o,t,e,r,i,n){return Ot(),Tt("div")}const $=Dt(Sr,[["render",wr],["__file","DistrictCluster.vue"]]);$.install=o=>(o.component($.name,$),o);const Er=$,kr=Ct({__name:"district-cluster",setup(o,{expose:t}){t();const e=j(15),r=j([116.33719,39.942384]),i=j(!0),n=()=>{i.value=!i.value},s=j([]),a=p=>{if(!p)return null;const f=p.split(",");return[parseFloat(f[0]),parseFloat(f[1])]};Yt(()=>{fetch("https://a.amap.com/amap-ui/static/data/10w.txt").then(p=>p.text()).then(p=>{s.value=p.split(`
`)})});const d={zoom:e,center:r,visible:i,changeVisible:n,clusterData:s,getPosition:a,clickMap:p=>{console.log("click map: ",p)},initMap:p=>{console.log("init map: ",p)},initLayer:p=>{console.log("聚合图层: ",p)},clickFeature:(p,f)=>{console.log("点击区划面： ",p,f)},get ElAmap(){return Ht},get ElAmapLayerDistrictCluster(){return Er}};return Object.defineProperty(d,"__isScriptSetup",{enumerable:!1,value:!0}),d}}),Lr={class:"map-page-container"},Ar={class:"toolbar"};function Ir(o,t,e,r,i,n){return Ot(),Tt(Qt,null,[Y("div",Lr,[ft(r.ElAmap,{"show-label":!1,center:r.center,zoom:r.zoom,"view-mode":"3D",pitch:20,onClick:r.clickMap,onInit:r.initMap},{default:Xt(()=>[ft(r.ElAmapLayerDistrictCluster,{"get-position":r.getPosition,data:r.clusterData,visible:r.visible,onFeatureClick:r.clickFeature,onInit:r.initLayer},null,8,["data","visible"])]),_:1},8,["center","zoom"])]),Y("div",Ar,[Y("button",{onClick:r.changeVisible},Jt(r.visible?"隐藏":"显示"),1)])],64)}const Nr=Dt(kr,[["render",Ir],["__file","district-cluster.vue"]]);export{Nr as default};
