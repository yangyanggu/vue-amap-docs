import{J as P,aI as I,aJ as M,au as F,w as C,M as E,ax as B}from"./three.module-BVXrWKE2.js";import{c as S}from"./threeUtil-BWGvaqqj.js";import{c as D,E as N,a as R}from"./index-CrMMG-jN.js";import{p as k,f as a,a8 as q,_ as O,o as f,c as _,al as L,az as G,a as g,d as j,w as V,q as H,s as U,ao as z}from"./app-BIv4BGsj.js";import{b as W,u as J,E as X}from"./index-XVBT3eyP.js";import"./arrayEach-Bzrg1Ilf.js";let Y=class{constructor(e){this.videoFrame=-1,this.layer=e}init(e,i){return this.video=e.video,this.object=new P,this.object.isCustomGroup=!0,this.object.$vue=i,new Promise(t=>{var l,u,m,v,r;(l=this.video)==null||l.load(),(u=this.video)==null||u.play();const o=new I(this.video),s=new M(e.videoWidth||((m=this.video)==null?void 0:m.videoWidth),e.videoHeight||((v=this.video)==null?void 0:v.videoHeight)),n=new F({map:o,side:C,transparent:!0,depthTest:!1}),h=new E(s,n);h.renderOrder=3,h.rotation.y=Math.PI,h.name="video",this.videoMesh=h,this.object.add(h),this.setVideoTranslate(e.videoTranslate),this.setPosition(e.position),this.setRotation(e.rotation),this.setScale(e.scale),this.setAltitude(e.altitude),(r=this.layer)==null||r.add(this.object),this.videoAnimate(),this.addBgCanvas(e.canvas),this.setAngle(e.angle),this.setOpacity(e.opacity),this.setzIndex(e.zIndex||0),this.bindAlwaysFront(e.alwaysFront),t()})}bindAlwaysFront(e){var i;if(e){const t=(i=this.layer)==null?void 0:i.getMap();this.rotateFun=D(this._changeMapRotate,this),t.on("rotatechange",this.rotateFun)}}unBindAlwaysFront(){var e;if(this.rotateFun){const i=(e=this.layer)==null?void 0:e.getMap();i&&i.off("rotatechange",this.rotateFun)}}_changeMapRotate(){var t;const i=((t=this.layer)==null?void 0:t.getMap()).getRotation();this.setAngle(i)}addBgCanvas(e){if(!e)return;const i=new B(e),t=new M(e.width,e.height),o=new F({map:i,side:C,transparent:!0,depthTest:!1}),s=new E(t,o);s.name="bg",s.renderOrder=1,this.object.add(s),this.canvasTexture=i,this.bgMesh=s}videoAnimate(){this.videoFrame=requestAnimationFrame(()=>{this.videoAnimate()}),this.canvasTexture&&(this.canvasTexture.needsUpdate=!0),this.refresh()}cancelCanvasTextureAnimate(){this.videoFrame>0&&cancelAnimationFrame(this.videoFrame)}setScale(e){let i;typeof e=="number"?i=[e,e,e]:i=e,this.object.scale.set(...i)}setPosition(e){var t;const i=(t=this.layer)==null?void 0:t.convertLngLat(e);this.object.position.setX(i[0]),this.object.position.setY(i[1]),this.refresh()}setRotation(e){if(e){const i=Math.PI/180*(e.x||0),t=Math.PI/180*(e.y||0),o=Math.PI/180*(e.z||0);this.object.rotation.set(i,t,o),this.refresh()}}setVideoTranslate(e){e&&(this.videoMesh.translateX(e.x),this.videoMesh.translateY(e.y),this.videoMesh.translateZ(e.z),this.refresh())}setAltitude(e){e!==void 0&&(this.object.position.setZ(e),this.refresh())}setAngle(e){if(e!==void 0){const i=this.object.rotation.x,t=this.object.rotation.z,o=Math.PI/180*e;this.object.rotation.set(i,o,t),this.refresh()}}setOpacity(e){this.videoMesh.material.opacity=e,this.bgMesh&&(this.bgMesh.material.opacity=e),this.refresh()}setzIndex(e){this.object.renderOrder=e}refresh(){var e;(e=this.layer)==null||e.update()}show(){this.object.visible=!0,this.refresh()}hide(){this.object.visible=!1,this.refresh()}start(){var e;(e=this.video)==null||e.play()}pause(){var e;(e=this.video)==null||e.pause()}remove(){var e;this.object&&((e=this.layer)==null||e.remove(this.object),this.unBindAlwaysFront())}destroy(){this.cancelCanvasTextureAnimate(),this.unBindAlwaysFront(),this.object&&(this.object.$vue=null,S(this.object),this.video=void 0,this.videoMesh=void 0,this.bgMesh=void 0,this.canvasTexture=void 0,this.rotateFun=void 0,this.object=null,this.layer=void 0)}};const Z=k({name:"ElAmapThreeVideo",inheritAttrs:!1,__name:"ThreeVideo",props:W({video:{type:[String,Array,HTMLVideoElement],required:!0},videoTranslate:{type:Object,default(){return{x:0,y:0,z:0}}},videoWidth:{type:Number},videoHeight:{type:Number},canvas:{type:Object},position:{type:Array,required:!0},altitude:{type:Number,default:0},rotation:{type:Object},scale:{type:[Number,Array],default:1},angle:{type:Number,default:0},opacity:{type:Number,default:1},alwaysFront:{type:Boolean,default:!1}}),emits:["init","click","mousemove","mouseover","mouseout"],setup(d,{expose:e,emit:i}){const t=i;let o;const s=a([]),n=a(),{$$getInstance:h,parentInstance:l}=J((r,w)=>{const b=Object.prototype.toString.call(r.video);return b==="[object String]"?s.value=[r.video]:b==="[object Array]"&&(s.value=r.video),s.value.length>0&&(r.video=n.value),o=new Y(w),new Promise(p=>{q(()=>{o.init(r,this).then(()=>{p(o)})})})},{emits:t,destroyComponent(){o&&(l!=null&&l.$amapComponent)&&(l.isDestroy||o.remove(),o.destroy(),o=null)}}),u=()=>{o.start()},m=()=>{o.pause()};e({$$getInstance:h,$$start:u,$$pause:m});const v={emits:t,get $amapComponent(){return o},set $amapComponent(r){o=r},videoUrlList:s,videoRef:n,$$getInstance:h,parentInstance:l,$$start:u,$$pause:m};return Object.defineProperty(v,"__isScriptSetup",{enumerable:!1,value:!0}),v}}),K={ref:"videoRef",style:{display:"none"},muted:"",loop:"",autoplay:"",crossOrigin:"anonymous"},Q=["src"];function $(d,e,i,t,o,s){return f(),_("video",K,[(f(!0),_(L,null,G(t.videoUrlList,n=>(f(),_("source",{key:n,src:n,type:"video/mp4"},null,8,Q))),128))],512)}const A=O(Z,[["render",$],["__file","ThreeVideo.vue"]]);A.install=d=>(d.component(A.name,A),d);const ee=A,te=k({__name:"three-video",setup(d,{expose:e}){e();const i="https://vue-amap.guyixi.cn/",t=a(!0),o=a([116.306206,39.975468]),s=a(15),n=a(!0),h=a({x:90,y:0,z:0}),l=a({x:0,y:70,z:0}),u=a(.5),m=a(200),v=a("https:////a.amap.com/jsapi/static/demo/third-user-demo/test.mp4"),r=a(.5),w=a({width:480,height:246}),b=a(!0),p=a();let y;const x={baseUrl:i,videoDestroy:t,center:o,zoom:s,visible:n,rotation:h,translate:l,scale:u,altitude:m,video:v,opacity:r,videoOption:w,alwaysFront:b,canvas:p,get context(){return y},set context(c){y=c},clickMap:c=>{console.log("click map: ",c)},initMap:c=>{var T;console.log("init map: ",c),p.value=document.createElement("canvas"),p.value.width=512,p.value.height=512,y=(T=p.value)==null?void 0:T.getContext("2d")},changeVisible:()=>{n.value=!n.value},changeDestroy:()=>{t.value=!t.value},initLayer:c=>{console.log("init layer: ",c)},init:()=>{const c=new Image;c.src=`${i}/images/screen.jpeg`,c.onload=()=>{y==null||y.drawImage(c,0,0)}},get ElAmap(){return X},get ElAmapLayerThree(){return N},get ElAmapThreeLightAmbient(){return R},get ElAmapThreeVideo(){return ee}};return Object.defineProperty(x,"__isScriptSetup",{enumerable:!1,value:!0}),x}}),ie={class:"map-page-container"},oe={class:"toolbar"};function se(d,e,i,t,o,s){return f(),_(L,null,[g("div",ie,[j(t.ElAmap,{"show-label":!1,center:t.center,zoom:t.zoom,"view-mode":"3D",pitch:60,"show-building-block":!1,features:["bg","road"],onClick:t.clickMap,onInit:t.initMap},{default:V(()=>[j(t.ElAmapLayerThree,null,{default:V(()=>[j(t.ElAmapThreeLightAmbient),t.canvas&&t.videoDestroy?(f(),H(t.ElAmapThreeVideo,{key:0,visible:t.visible,video:t.video,"video-width":t.videoOption.width,"video-height":t.videoOption.height,"video-translate":t.translate,canvas:t.canvas,position:t.center,scale:t.scale,altitude:t.altitude,rotation:t.rotation,opacity:t.opacity,"always-front":t.alwaysFront,onInit:t.init},null,8,["visible","video","video-width","video-height","video-translate","canvas","position","scale","altitude","rotation","opacity","always-front"])):U("",!0)]),_:1})]),_:1},8,["center","zoom"])]),g("div",oe,[g("button",{onClick:t.changeVisible},z(t.visible?"隐藏":"显示"),1),g("button",{onClick:t.changeDestroy},z(t.videoDestroy?"销毁":"创建"),1)])],64)}const be=O(te,[["render",se],["__file","three-video.vue"]]);export{be as default};
